\chapter{DUNE Near Detector-driven reweighting}
\label{sec:dune_ndrwt}

%% Why do we want to do this?
%% Interaction models in LBL experiments discrepant and found to not match data
Models of neutrino interaction are frequently found to not match observed data.

%% Inputing an alternate interaction model as our data biases oscillation parameters significantly

%% Role of the gas TPC

%% Presentation of DUNE energy spectrum
\citefig{fig:energyByMode} shows the energy spectrum of \numu and \anumu charged current interactions in ND-GAr for both FHC and RHC.
The spectrum is subdivided into true final state pion multiplicities. 
One can see that the energy range of the DUNE beam means that a wide range of event topologies will be present.
Additionally, one can see that the dominant final states are the ones containing no pions and ones containing a single charged pion.

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/energyByModeFhc}	
		\end{adjustbox}
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/energyByModeRhc}	
		\end{adjustbox}
	\end{minipage}
	\caption[Neutrino energy spectrum in ND-GAr divided by pion multiplicity]{Neutrino energy spectra in ND-GAr for charged current \numu and \anumu events with the beam in FHC mode (left) and RHC mode (right). Events are divided by true final state pion multiplicity with the histograms stacked.}
	\label{fig:energyByMode}
\end{figure}

%% Details on GENIE->NuWro BDT
\section{NuWro reweighting Boosted Decision Tree}
\label{sec:dune_ndrwt:bdt}

Generating fully reconstructed Monte Carlo samples with alternative neutrino interaction generators is a process that consumes many CPU hours as well as requiring significant human effort to undertake.
Therefore, an alternative method is devised whereby existing samples can be reweighted on an event-by-event basis such that the true kinematic distributions of the reweighted sample can come to resemble those produced by an alternative neutrino interaction generator.

This reweighting is performed by a boosted decision tree (BDT).
This BDT is trained on two samples, termed the `nominal' and `mock'.
In this particular case, the `nominal' sample is GENIE, while the `mock' sample is NuWro.
This does require an additional sample to be generated but does not require the full simulation and reconstruction chain.

For each of the samples, 18 true variables describing the neutrino interaction are used as the inputs to the BDT.
These 18 variables broadly fall into two categories, those concerning the kinematics of the interaction and those concerning final state particles. Those in the former category are the neutrino energy, the outgoing lepton energy, the angle between the outgoing lepton and the neutrino, the squared four momentum transfer ($Q^{2}$), the hadronic invariant mass ($W$), Bj\"orken $x$ and the inelasticity of the collision ($y$).
In the latter category the variables are the number and total energy of final state protons, neutrons, \piplus, \piminus and \pizero. 
Finally, the number of electromagnetic objects in the final state is also used.
The BDT is then trained to classify interactions as either the `nominal' or `mock' based upon these variables.
The output of the BDT is then used to weight `nominal' events~\cite{vilelaBDT}.

\section{Simulation details}
\label{sec:dune_ndrwt:simDetails}

Initially, a sample of \num{10000000} neutrino interactions (\num{5000000} in each of FHC and RHC mode) is simulated using the GENIE~\cite{genie} neutrino interaction generator within the HPgTPC volume.
This number of interactions is roughly what would be expected given the delivery of \num{9.66d20} protons to the neutrino beam target in FHC mode and \num{1.96d21} protons to the same target in RHC mode.
The final state particles produced in these interactions are then propagated through an accurate representation of the DUNE near detector hall (see \citesec{sec:dune:nd}) using \texttt{GEANT4}~\cite{geant}. 
 
A parametrised reconstruction is then used to give an estimate of the measured energy of these particles.
The parametrised reconstruction takes the \texttt{GEANT4} energy deposits and smears them according to the Gluckstern formula~\cite{gluckstern}.
This formula allows the error on a track's curvature (due to motion in a magnetic field) to be estimated.
This can then be extended to give the fractional uncertainty on the particle momentum as
\begin{equation}
	\left(\frac{\sigma_{p}}{p}\right)^{2} = \left( \frac{\sigma_{x} p}{0.3 B L^{2}} \sqrt{ \frac{720}{N+4} } \right)^{2} +
	\left( \frac{\SI{0.0157}{\GeV\per\clight}}{0.3BL}\sqrt{\frac{L}{X_{0}}}\left( 1 + 0.038 \ln(L/X_{0}) \right) \right)^{2}
\end{equation}
where $L$ is the track length perpendicular to the magnetic field, $\sigma_{x}$ is the point resolution, $N$ is the number of hits in the track and $X_0$ is the radiation length of the material which the particle is traversing.
In the HPgTPC, $B$ is taken to be \SI{0.4}{\tesla}, $X_{0}$ is taken to be \SI{13}{\cm}, $\sigma_{x}$ is taken to be \SI{1}{\mm} and the number of track hits is estimated by dividing the track length by the pad pitch of the HPgTPC.
Charged particles with track lengths of more than \SI{6}{\cm} are considered to be able to be reconstructed using this method.

It is assumed that charged pions and protons with $p < \SI{1.5}{\GeV\per\clight}$ are able to be perfectly separated using measurements of particle $dE/dx$.
Above this momentum a parametrisation of the ECAL is used since it is assumed that $dE/dx$ will be too similar for protons and charged pions.
Here, the reconstructed energy of the particle in the ECAL is estimated with a resolution of 
$20\% \oplus \frac{30\%}{\sqrt{T}}$, where $T$ is the kinetic energy of the particle.
This estimate of the energy is then compared with that derived from the momentum measurements made using track curvature under the assumption that the particle is a proton or a pion.
The closer of these two values to the reconstructed ECAL energy determines the reconstructed particle type.

Neutral pions are considered to be reconstructed if both decay photons have energies of more than \SI{50}{\MeV} and the angle between the two photons is larger than 0.01~radians (i.e. they do not lie on top of one another).
It is assumed that for photons $\sigma_{E}/E = 0.1$.

Finally, a degree of confusion between muons and charged pions is implemented.
If the highest momentum muon or charged pion is a muon then the particle is correctly identified.
However, if a charged pion has a higher momentum there is a chance for the particle to be incorrectly reconstructed as a muon.
If the charged pion has a momentum of less than \SI{0.4}{\GeV\per\clight} it is assumed that it can be correctly identified from its range within the ECAL.

For pions in the energy range $\SI{0.4}{\GeV\per\clight} < p < \SI{1.0}{\GeV\per\clight}$ the pion is correctly identified if it interacts in the ECAL.
The probability for a pion to leave the ECAL without interacting is determined from \citefig{fig:interactionSpline}.
\citefig{fig:interactionSpline} shows the probability for a pion to not interact in the ECAL at various momenta with a spline plotted through the points.
The points are determined from simulations of the ECAL.

\begin{figure}[h]
	\centering
	\begin{adjustbox}{max totalsize=.6\linewidth, center}
		\input{files/figures/dune_ndrwt/interactionSpline}
	\end{adjustbox}
	\caption[Non-interaction probability for a charged pion travelling through the ND-GAr ECAL as a function of momentum]{Non-interaction probability for a charged pion travelling through the ND-GAr ECAL as a function of momentum. Points derived from simulation are shown in red through which a spline is plotted (black).}
	\label{fig:interactionSpline}
\end{figure}

Charged pions with $p>\SI{1}{\GeV\per\clight}$ are considered to have passed into the muon identification system. 
This system has a thickness of approximately 2 interaction lengths for charged pions.
If the pion interacts in the muon identification system, it is correctly identified.
Therefore, these pions have a probability of $e^{-3}$ to be misidentified as muons.

Finally, it is assumed that the detector is able to perfectly sign select particles such as charged pions and muons.

\section{Measurements of pion multiplicity}
\label{sec:dune_ndrwt:pionMulti}

The parametrised reconstruction detailed in \citesec{sec:dune_ndrwt:simDetails} is used to select muon neutrino events and classify their final state.
An event is considered to be a \numu or \anumu charged current event if there is a reconstructed muon in the final state which has a track length perpendicular to the magnetic field of over \SI{1}{\metre}.
Alternatively, if the reconstructed muon exits the HPgTPC and ranges out in the ECAL it is also reconstructed as a \numu CC event.
The term `ranging out' here refers to a particle stopping in the detector without interacting.
The muon is judged to have ranged out in the ECAL if it has a momentum of less than \SI{380}{\MeV\per\clight} when exiting the HPgTPC. 

\citefig{fig:confusMatPi} shows the confusion matrices produced using the above selection for both forward and reverse horn currents. 
Here one can see that, for all final states, the correct final state is reconstructed at least 88\% of the time.
%The largest probability for miscategorised events are NC events where single charged pion is wrongly reconstructed as a muon and the whole event is categorised as a $0\pi$ final state.
%However, one can see from \citefig{fig:eventCats}, that these represent a very small fraction of the total number of events.

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/confusionCatFhc}
		\end{adjustbox}
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/confusionCatRhc}
		\end{adjustbox}
	\end{minipage}
	\caption[Confusion matrices for final state pion multiplicities in ND-GAr]{Left: Confusion matrix for final state pion multiplicities in ND-GAr with the neutrino beam in FHC mode. Right: Confusion matrix for final state pion multiplicities in ND-GAr with the neutrino beam in RHC mode.}
	\label{fig:confusMatPi}
\end{figure}

%\begin{figure}[h]
%	\begin{minipage}[t]{.49\linewidth}
%		\begin{adjustbox}{max totalsize=\linewidth, center}
%			\input{files/figures/dune_ndrwt/h2CatsFhc}
%		\end{adjustbox}
%	\end{minipage}
%	\hfill
%	\begin{minipage}[t]{.49\linewidth}
%		\begin{adjustbox}{max totalsize=\linewidth, center}
%			\input{files/figures/dune_ndrwt/h2CatsRhc}
%		\end{adjustbox}
%	\end{minipage}
%	\caption[True and reconstructed event categories for ND-GAr events]{Left: True and reconstructed final state pion multiplicities in ND-GAr with the neutrino beam in FHC mode. Right: True and reconstructed final state pion multiplicities in ND-GAr with the neutrino beam in RHC mode.}
%	\label{fig:eventCats}
%\end{figure}

The reconstructed squared momentum transfer for CC muon neutrino events is defined as
\begin{equation}
Q^{2}_{\textrm{reco}} = 2E_{\nu, \textrm{reco}} \left( E_{\mu, \textrm{reco}} - p_{\mu, \textrm{reco}} \cos \left( \theta_{\mu, \textrm{reco}} \right) \right) - m_{\mu}^{2}
\end{equation}
where $E_{\nu, \textrm{reco}}$ is the sum of the reconstructed muon energy and the reconstructed final state hadron energies, $E_{\mu, \textrm{reco}}$ and $p_{\mu, \textrm{reco}}$ are the reconstructed energy and momentum of the final state muon and $\theta_{\mu, \textrm{reco}}$ is the reconstructed angle between the muon and the neutrino beam.

The mock data generator detailed in \citesec{sec:dune_ndrwt:bdt} used to reweight events to give an approximation of NuWro data.
A distribution of $Q^{2}_{\textrm{reco}}$ is then constructed for each of the nominal GENIE sample and the reweighted sample. 
The ratio between the two samples is then taken and plotted. 

These ratios are shown in \citefigL{fig:Q2CompFhc} and \citefigL{fig:Q2CompRhc}. 
Here, one can clearly see that, for all final states apart from $0\pi$, clear differences between GENIE and NuWro are observable.

The errors on the points resulting from confusion between the final states are estimated using the following method.
Distributions of $Q^{2}_{\textrm{reco}}$ are produced for each of the $i$ true final states for GENIE and NuWro and then the ratio between the two is calculated as before.
For the final state in question, $x$, the value of $n$th bin in this histogram is taken as the true central value $R_{\textrm{CV}, x}(n)$.
The variance of the $n$th bin is calculated as follows:
\begin{equation}
	\sigma_{x}^{2}(n) = \sum_{i=1}^{5} \left( R_{a}(n) - R_{\textrm{CV}, x}(n) \right)^{2} * \frac{M_{i x}}{N_{x}}
\end{equation}
where $i$ runs over the final states and $M$ is the smearing matrix in \citefig{fig:confusMatPi} corresponding to the correct horn current.
The constant $N$ is a normalisation factor determined by summing the bin contents of row $x$ of the smearing matrix. 

Additionally, \citefigR{fig:Q2CompFhc} and \citefigR{fig:Q2CompRhc} show the equivalent distributions for true selections and variables. 
One can see that these distributions replicate many of the features of the reconstructed distributions well.

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hsFhcQ2Reco_spread}
		\end{adjustbox}
	\end{minipage}
 	\hfill
 	\begin{minipage}[t]{.5\linewidth}
 		\begin{adjustbox}{max totalsize=\linewidth, center}
 			\input{files/figures/dune_ndrwt/hsFhcQ2Vis}
 		\end{adjustbox}
 	\end{minipage}
 	\caption[Comparison of NuWro and GENIE in $Q^{2}_{\textrm{vis}}$ for FHC]{Ratio of NuWro to GENIE event rates in ND-GAr as a function of $Q^{2}_{\textrm{vis}}$ with the beam in FHC mode. Left: Reconstructed selection. Right: True selection.}
 	\label{fig:Q2CompFhc}
\end{figure}

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hsRhcQ2Reco_spread}
		\end{adjustbox}
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hsRhcQ2Vis}
		\end{adjustbox}
	\end{minipage}
	\caption[Comparison of NuWro and GENIE in $Q^{2}$ for RHC]{Ratio of NuWro to GENIE event rates in ND-GAr as a function of $Q^{2}$ with the beam in RHC mode. Left: Reconstructed selection. Right: True selection.}
	\label{fig:Q2CompRhc}
\end{figure}

\subsection{Liquid argon}

Attempts to simulate measuring the same quantities are also made in the liquid argon component of the DUNE near detector, ND-LAr (see \citesec{sec:dune:nd:lar}).
ND-LAr has some key difference to ND-GAr in the case of separating out final states, however. 
Due to the lack of a magnetic field covering ND-LAr, hadronic interactions can only be reconstructed calorimetrically.

Because liquid argon is a denser medium than gaseous argon final hadrons will may not result in a reconstructed track due to the very short distance travelled.
Additionally, very high energy hadrons are more likely to scatter in liquid argon, making track reconstruction difficult.

Finally, ND-LAr does not have an equivalent to the ECAL in ND-GAr.
This means that protons and pions can be separated by track $dE/dx$ only.

\citefig{fig:larConfusMat} shows the equivalent confusion matrix to \citefigL{fig:confusMatPi} for ND-LAr.
Here one can see that, although around 60\% of final states are reconstructed correctly, the performance is not at the level of ND-GAr.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.6\linewidth, center}
		\input{files/figures/dune_ndrwt/larConfusMat}
	\end{adjustbox}
	\caption[Final state pion multiplicity confusion matrix from ND-LAr simulations]{Final state pion multiplicity confusion matrix from ND-LAr simulations, from~\cite{ndCdr}. The colour axis is probability.}
	\label{fig:larConfusMat}
\end{figure}

\citefig{fig:q2LarFhc} shows the ND-LAr equivalent to \citefigL{fig:Q2CompFhc}. 
Here, one can see that the errors are larger in most cases (compared to \citefigL{fig:Q2CompFhc}) due to the increased confusion between categories.
However, in spite of this, it still seems that significant differences are visible for some of the final state topologies in ND-LAr.

\begin{figure}[h]
	\centering
	\includegraphics[width=.6\linewidth]{files/figures/dune_ndrwt/larQ2Reco}
	\caption[Ratio of $Q^{2}_{\textrm{reco}}$ between GENIE and NuWro mock data in ND-LAr]{Ratio of $Q^{2}_{\textrm{reco}}$ between GENIE and NuWro mock data in ND-LAr, from~\cite{ndCdr}. Bins with $<100$ MC events are suppressed.}
	\label{fig:q2LarFhc}	
\end{figure}

\section{Near detector-driven reweighting}
\label{sec:dune_ndrwt:rwt}

% Why we have a near detector
As mentioned in \citesec{sec:dune:nd}, one of the reasons for the inclusion of a near detector in a long baseline neutrino oscillation experiment to allow the constraint of various neutrino cross-section systematics.
However, it may be that existing neutrino interaction models and their associated uncertainties do not explain the observed reconstructed neutrino energy spectra.

%% If we observe some cross-section effect that is not explained by our model in ND what do we do?

\citefig{fig:fdSamplesPostFit} shows the four far detector samples (one appearance and one disappearance for each horn current) used in a typical oscillation analysis.
For each sample the nominal GENIE MC is plotted in blue along with the NuWro `mock data' as black points.

The red line shows the post-fit result of a far detector-only fit with all flux, detector and cross-section systematics at their nominal values. 
For the purposes of this fit the nominal MC is GENIE and the data is the NuWro `mock data'.
The $\chi^{2}$ value for the post-fit distribution is 2.29 indicating good agreement.

\begin{figure}[h]
	\begin{subfigure}[t]{0.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/numuFhcPostfitComp}
		\end{adjustbox}	
		\caption{\numu FHC}	
	\end{subfigure}	
	\hfill
	\begin{subfigure}[t]{0.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/nueFhcPostfitComp}
		\end{adjustbox}	
		\caption{\nue FHC}	
	\end{subfigure} \\ 
	\begin{subfigure}[t]{0.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/numuRhcPostfitComp}
		\end{adjustbox}	
		\caption{\numu RHC}	
	\end{subfigure}	
	\hfill
	\begin{subfigure}[t]{0.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/nueRhcPostfitComp}
		\end{adjustbox}		
		\caption{\nue RHC}
	\end{subfigure}
	\caption[Examples of far detector spectra for both the nominal GENIE MC and NuWro `mock data' along with the post-fit spectrum]{Examples of far detector spectra for both the nominal GENIE MC and NuWro `mock data' along with the post-fit spectrum. Here the true value of \dcp is \ang{90}, the mass ordering is normal and all other parameters are at the NuFit 4.0 best fit points~\cite{nufit}.}
	\label{fig:fdSamplesPostFit}
\end{figure}

However, many of the systematic parameters have moved from their nominal values in order to accommodate the differing shapes of the data and MC.
Additionally, several of the oscillation parameters have moved away from their true values.
Most notably, the value of \dcp has moved from its true value (in this case) of \ang{90} to a best fit point of \ang{64.9}, a bias of \ang{25.1}.

This process is performed at multiple different \dcp points and the bias in \dcp measured. 
The resulting bias as a function of $\delta_{CP, \text{true}}$ is shown in \citefig{fig:dcpBiasNoWgt}.
One can see that the bias in \dcp varies between being negligible and up to approximately \ang{32}. 

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.6\linewidth, center}
		\input{files/figures/dune_ndrwt/dcpBiasNoWgt}
	\end{adjustbox}
	\caption[Example of \dcp bias in FD-only fits using NuWro data]{Bias in \dcp generated in FD-only fits using NuWro as `mock data' as a function of the true value of \dcp.}
	\label{fig:dcpBiasNoWgt}
\end{figure}

Given that there is a large variation in the observed bias and the value of \dcp is not known, a useful metric to judge the level of bias by is the value for which 68\% of biases are below.
In this case, this number is \ang{16.2}.

This can be compared with the expected DUNE resolution on \dcp, shown in \citefig{fig:dcpResDUNE}. 
One can see that these biases are comparable to the eventual expected \dcp resolution of DUNE.
\begin{figure}[h]
	\centering
	\includegraphics[width=.5\linewidth]{files/figures/dune_ndrwt/dcpResWithLines-cropped}
	\caption[\dcp resolution of DUNE as a function of exposure]{\dcp resolution of DUNE as a function of exposure, from~\cite{Abi:2020qib}. Additionally, a line has been drawn indicating the maximal \dcp bias created by using this incorrect interaction model (blue). The green line indicates the 68\% limit of \dcp biases.}
	\label{fig:dcpResDUNE}
\end{figure}

This bias indicates that the neutrino interaction model does not contain the required degrees of freedom to account for this alternative model.


The rest of this section is dedicated to a discussion of how it is possible to use information from ND-GAr to reduce these out-of-model biases.
Specifically, ND-GAr measures events in 3 dimensions (a two dimensional kinematic space divided up by final state) for both the nominal MC and the `mock data' sample and develops a set of weights.
The final states used are discussed in \citesec{sec:dune_ndrwt:rwt:states} while the kinematic space used is discussed in \citesec{sec:dune_ndrwt:rwt:kinematics}.
These weights are then propagated to DUNE far detector events. 
This process is described in \citesec{sec:dune_ndrwt:rwt:fd}.

\subsection{Choice of final states}
\label{sec:dune_ndrwt:rwt:states}

The reweighting is divided up into 7 final states for both horn currents.
The chosen final states are mainly based on final state pion multiplicity since the DUNE beam will produce produce a large quantity of various multiplicities.
Additionally, \citesec{sec:dune_ndrwt:pionMulti} shows that ND-GAr has a high accuracy when identifying these final states.

The chosen final states are:
\begin{itemize}
	\item $0\pi$ with a single proton in the final state
	\item $0\pi$ with more than one proton in the final state
	\item $1\piplus$ in the final state
	\item $1\piminus$ in the final state
	\item $1\pizero$ in the final state
	\item $2\pi$ in the final state, their charge is not relevant
	\item $>2\pi$ in the final state, their charge is not relevant.
\end{itemize}

The choice is made to separate the $0\pi$ final state into two separate categories due to the different processes which contribute to these final states.
A signal proton final state is commonly produced via charged current quasi-elastic (CCQE) scattering which, for a free nucleon, can be represented by the reactions
\begin{align}
	\nul + n &\rightarrow l^{-} + p \\
	\anul + p &\rightarrow l^{+} + n \, .
\end{align}
In this case the $W$ boson is absorbed by just one nucleon.

However, in a 2p2h event the $W$ boson is absorbed by two interacting nucleons within the nucleus, potentially leading to two protons in the observed final state~\cite{2p2h}.
Because different neutrino interaction generators model these processes differently, it is decided to divide the $0\pi$ category into these two final states to try and better observe any differences.

\subsection{Choice of variables}
\label{sec:dune_ndrwt:rwt:kinematics}

Two variables are defined in which the reweighting takes place, the visible energy transfer and the visible momentum transfer. 
These variables are termed \evis and \pvis respectively.
\evis is defined as 
\begin{equation}
	\evis = T_{\textrm{p}} + E_{\pi}
\end{equation}
where $T_{\textrm{p}}$ is the total kinetic energy of any final state protons and $E_{\pi}$ is the total energy (including rest masses) of any final state pions.
One can see that any energy carried by neutrons is not measured in this definition.

\pvis is defined as
\begin{equation}
	\pvis = \sqrt{ 2(\evis + E_{\mu})(E_{\mu} - p_{\mu}\cos\theta_{\mu}) - m_{\mu}^{2} + \evis^{2} }
\end{equation}
where $E_{\mu}$ and $p_{\mu}$ are the energy and momentum of the outgoing muon.
$\theta_{\mu}$ is the angle between the outgoing muon and incoming neutrino.

Distributions of true vs. reconstructed \evis and \pvis are shown in \citefig{fig:visibleTrueReco}.
One can clearly see that in both cases, the distributions are highly diagonal.

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/q0CompFhc}
		\end{adjustbox}	
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/q3CompFhc}
		\end{adjustbox}
	\end{minipage}
	\caption[True vs. reconstructed \evis (left) and \pvis (right)]{2-dimensional distributions showing relationship between true and reconstructed \evis (left) and \pvis (right). In both cases the distributions are area normalised to 1.}
	\label{fig:visibleTrueReco}
\end{figure}

Examples of 2-dimensional distributions of these quantities for various reconstructed final states are shown in \citefig{fig:q0q3Genie}.
One can observe substantial variations in the distributions as a function of final state.

\begin{figure}[t]
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat7_genie}
		\end{adjustbox}
		\caption{$0\pi$ - 1 proton}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat8_genie}
		\end{adjustbox}
		\caption{$0\pi$ - $>1$ proton}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat3_genie}
		\end{adjustbox}
		\caption{$1\piplus$}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat4_genie}
		\end{adjustbox}
		\caption{$1\pizero$}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat5_genie}
		\end{adjustbox}
		\caption{$2\pi$}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat6_genie}
		\end{adjustbox}
		\caption{$>2\pi$}
	\end{subfigure}
	\caption[Two dimensional distributions of $E_{\text{vis}}$ and $p_{\text{vis}}$ in ND-GAr]{Two dimensional distributions of reconstructed $E_{\text{vis}}$ and $p_{\text{vis}}$ in ND-GAr, separated out by final state. One can see that different final states populate different regions of the plot.}
	\label{fig:q0q3Genie}
\end{figure}

The same distributions as those displayed in \citefig{fig:q0q3Genie} are plotted for the NuWro mock data.
The ratio of these two distributions is then taken.
That is the number of events in each bin for the mock data sample is divided by the number of events in the same bin for the nominal sample.
These ratios are shown for FHC in \citefig{fig:q0q3RatioFhc}.
In the case that any bin contains less than \num{100} MC events, its value is set to 1.
This avoids events being given large weights due to statistical fluctuations.

\begin{figure}[t]
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat7_ratio}
		\end{adjustbox}
		\caption{$0\pi$ - 1 proton}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat8_ratio}
		\end{adjustbox}
		\caption{$0\pi$ - $>1$ proton}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat3_ratio}
		\end{adjustbox}
		\caption{$1\piplus$}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat4_ratio}
		\end{adjustbox}
		\caption{$1\pizero$}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat5_ratio}
		\end{adjustbox}
		\caption{$2\pi$}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat6_ratio}
		\end{adjustbox}
		\caption{$>2\pi$}
	\end{subfigure}
	\caption[Ratio of NuWro to GENIE of two-dimensional distributions of \evis and \pvis in ND-GAr]{Two dimensional distributions of reconstructed \evis and \pvis in ND-GAr, separated out by pion multiplicity.}
	\label{fig:q0q3RatioFhc}
\end{figure}

\subsection{Far detector samples}
\label{sec:dune_ndrwt:rwt:fd}

These weights shown in \citefig{fig:q0q3RatioFhc} are used to reweight the nominal far detector MC.
For each FD event the true final state is identified and true values of \evis and \pvis are calculated.
The true final state determines which reweighting histogram is used while the true values of \evis and \pvis determine the weight.

\citefig{fdWeights} shows distribution of weights applied to each far detector sample.
The weights are shown for both reconstructed \numu and \nue for both horn currents.
One can observe that these weights are mainly clustered around 1 but with a significant spread.

\begin{figure}[h]
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtFHCnonswap}
		\end{adjustbox}
		\caption{FHC: reco \numu}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtFHCnueswap}
		\end{adjustbox}
		\caption{FHC: reco \nue}
	\end{subfigure}	\\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtRHCnonswap}
		\end{adjustbox}
		\caption{RHC: reco \numu}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtRHCnueswap}
		\end{adjustbox}
		\caption{RHC: reco \nue}
	\end{subfigure}
	\caption[ND-GAr derived weights applied to far detector events]{ND-GAr derived weights applied to far detector events for both horn currents.}
	\label{fig:fdWeights}
\end{figure}

An example of four far detector samples with and without the reweighting, together with the mock data is shown in \citefig{fig:reweightedSamples}.
One can observe significant shifts for all the MC samples after the reweighting has been performed.

\begin{figure}[h]
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtMCComp_fhcNumu}
		\end{adjustbox}
		\caption{FHC \numu}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtMCComp_fhcNue}
		\end{adjustbox}
		\caption{FHC \nue}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtMCComp_rhcNumu}
		\end{adjustbox}
		\caption{RHC \anumu}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtMCComp_rhcNue}
		\end{adjustbox}
		\caption{RHC \anue}
	\end{subfigure}
	\caption[Comparison of weighted and unweighted far detector MC with mock data]{Comparison of weighted and unweighted far detector MC with mock data. Here, $\dcp=\pi$.}
	\label{fig:reweightedSamples}
\end{figure}

Additionally, the ratio to data for each of the MC samples is shown in \citefig{fig:reweightedSamplesRatio}.
\citefig{fig:reweightedSamplesRatio} also shows the calculated $\chi^{2}$ values for each MC sample when compared with the `mock data'.
Here, one can see that at this particular set of oscillation parameters the $\chi^{2}$ for all samples apart from \nue RHC is lower for the weighted sample than the unweighted one.
This indicates that the reweighting is bringing the MC closer to the mock data.

\begin{figure}[h]
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtMCRatio_fhcNumu}
		\end{adjustbox}
		\caption{FHC \numu}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtMCRatio_fhcNue}
		\end{adjustbox}
		\caption{FHC \nue}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtMCRatio_rhcNumu}
		\end{adjustbox}
		\caption{RHC \anumu}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/wgtMCRatio_rhcNue}
		\end{adjustbox}
		\caption{RHC \anue}
	\end{subfigure}
	\caption[Ratio of weighted and unweighted far detector MC samples to `mock data']{Ratio of weighted and unweighted far detector MC samples to `mock data'. Additionally, for each sample, $\chi^{2}$ values are calculated for both MC samples and the `mock data' and displayed. Here, the true value of \dcp is $\pi$.}
	\label{fig:reweightedSamplesRatio}
\end{figure} 

Additionally, one can also see that differences remain between the weighted MC and `mock data'. 
These differences are the result of a number of different factors.

Firstly, the far detector events are reweighted on the basis of true \evis and \pvis and true final state.
These quantities do not correspond directly to the reconstructed quantities measured in ND-GAr and thus there will be deficiencies in the reweighting deriving from this.
However, it is not possible to reweight based upon the reconstructed energy of far detector events due to the differences in reconstruction techniques between ND-GAr and the FD.
Additionally, it may be more difficult in the FD to exclude energy carried by final neutrons from hadronic energy estimators.
A LAr TPC such as the FD may also find it more difficult to correctly identify final state pion multiplicities compared to ND-GAr, as shown in \citefig{fig:larConfusMat}.

Furthermore, many differences exist between the GENIE and NuWro which may not be encapsulated in the 3-dimensional reweighting space chosen.
An extension to further dimensions may mitigate these issues.
However, this approach relies on sufficient statistics in ND-GAr such that all parts of phase space are reasonably well populated.

\subsection{Bias reduction as a function of \dcp}
\label{sec:dune_ndrwt:rwt:biasReduction}

Far detector fits are performed at a variety of values of \dcp with the reweighted far detector samples as the MC.
\citefig{fig:dcpBiasWithWgt} shows the variation in the bias in the fitted value of \dcp as a function of $\delta_{CP, \text{true}}$ when using the reweighted MC.
The points made by using the unweighted MC are also included for comparison.
One can see that at most points, the bias on \dcp is lessened when the weighted MC is used.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.6\linewidth, center}
		\input{files/figures/dune_ndrwt/dcpBiasWithWgt}
	\end{adjustbox}
	\caption[Bias in fit value of \dcp with ND-GAr reweighted MC]{Bias in the measured value of \dcp as a function of the true value of \dcp. Points for both the nominal GENIE MC and the reweighted MC are shown.}
	\label{fig:dcpBiasWithWgt}
\end{figure}
