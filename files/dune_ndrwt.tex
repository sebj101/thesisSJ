\chapter{DUNE Near Detector-driven reweighting}
\label{sec:dune_ndrwt}

%% Why do we want to do this?
%% Interaction models in LBL experiments discrepant and found to not match data
Models of neutrino interaction are frequently found to not match observed data.

%% Inputing an alternate interaction model as our data biases oscillation parameters significantly

%% Role of the gas TPC

%% Presentation of DUNE energy spectrum
\citefig{fig:energyByMode} shows the energy spectrum of \numu and \anumu charged current interactions in ND-GAr for both FHC and RHC.
The spectrum is subdivided into true final state pion multiplicities. 
One can see that the energy range of the DUNE beam means that a wide range of event topologies will be present.
Additionally, one can see that the dominant final states are the ones containing no pions and ones containing a single charged pion.

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/energyByModeFhc}	
		\end{adjustbox}
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/energyByModeRhc}	
		\end{adjustbox}
	\end{minipage}
	\caption[Neutrino energy spectrum in ND-GAr divided by pion multiplicity]{Neutrino energy spectra in ND-GAr for charged current \numu and \anumu events with the beam in FHC mode (left) and RHC mode (right). Events are divided by true final state pion multiplicity with the histograms stacked.}
	\label{fig:energyByMode}
\end{figure}

%% Details on GENIE->NuWro BDT
\section{NuWro reweighting Boosted Decision Tree}
\label{sec:dune_ndrwt:bdt}

Generating fully reconstructed Monte Carlo samples with alternative neutrino interaction generators is a process that consumes many CPU hours as well as requiring significant human effort to undertake.
Therefore, an alternative method is devised whereby existing samples can be reweighted on an event-by-event basis such that the true kinematic distributions of the reweighted sample can come to resemble those produced by an alternative neutrino interaction generator.

This reweighting is performed by a boosted decision tree (BDT).
This BDT is trained on two samples, termed the `nominal' and `mock'.
In this particular case, the `nominal' sample is GENIE, while the `mock' sample is NuWro.
This does require an additional sample to be generated but does not require the full simulation and reconstruction chain.

For each of the samples, 18 true variables describing the neutrino interaction are used as the inputs to the BDT.
These 18 variables broadly fall into two categories, those concerning the kinematics of the interaction and those concerning final state particles. Those in the former category are the neutrino energy, the outgoing lepton energy, the angle between the outgoing lepton and the neutrino, the squared four momentum transfer ($Q^{2}$), the hadronic invariant mass ($W$), Bj\"orken $x$ and the inelasticity of the collision ($y$).
In the latter category the variables are the number and total energy of final state protons, neutrons, \piplus, \piminus and \pizero. 
Finally, the number of electromagnetic objects in the final state is also used.
The BDT is then trained to classify interactions as either the `nominal' or `mock' based upon these variables.
The output of the BDT is then used to weight `nominal' events~\cite{vilelaBDT}.

\section{Simulation details}
\label{sec:dune_ndrwt:simDetails}

Initially, a sample of \num{10000000} neutrino interactions (\num{5000000} in each of FHC and RHC mode) is simulated using the GENIE~\cite{genie} neutrino interaction generator within the HPgTPC volume.
This number of interactions is roughly what would be expected given the delivery of \num{9.66d20} protons to the neutrino beam target in FHC mode and \num{1.96d21} protons to the same target in RHC mode.
The final state particles produced in these interactions are then propagated through an accurate representation of the DUNE near detector hall (see \citesec{sec:dune:nd}) using \texttt{GEANT4}~\cite{geant}. 
 
A parametrised reconstruction is then used to give an estimate of the measured energy of these particles.
The parametrised reconstruction takes the \texttt{GEANT4} energy deposits and smears them according to the Gluckstern formula~\cite{gluckstern}.
This formula allows the error on a track's curvature (due to motion in a magnetic field) to be estimated.
This can then be extended to give the fractional uncertainty on the particle momentum as
\begin{equation}
	\left(\frac{\sigma_{p}}{p}\right)^{2} = \left( \frac{\sigma_{x} p}{0.3 B L^{2}} \sqrt{ \frac{720}{N+4} } \right)^{2} +
	\left( \frac{\SI{0.0157}{\GeV\per\clight}}{0.3BL}\sqrt{\frac{L}{X_{0}}}\left( 1 + 0.038 \ln(L/X_{0}) \right) \right)^{2}
\end{equation}
where $L$ is the track length perpendicular to the magnetic field, $\sigma_{x}$ is the point resolution, $N$ is the number of hits in the track and $X_0$ is the radiation length of the material which the particle is traversing.
In the HPgTPC, $B$ is taken to be \SI{0.4}{\tesla}, $X_{0}$ is taken to be \SI{13}{\cm}, $\sigma_{x}$ is taken to be \SI{1}{\mm} and the number of track hits is estimated by dividing the track length by the pad pitch of the HPgTPC.

It is assumed that charged pions and protons with $p < \SI{1.5}{\GeV\per\clight}$ are able to be perfectly separated using measurements of particle $dE/dx$.
Above this momentum a parametrisation of the ECAL is used since it is assumed that $dE/dx$ will be too similar for protons and charged pions.
Here, the reconstructed energy of the particle in the ECAL is estimated with a resolution of 
$20\% \oplus \frac{30\%}{\sqrt{T}}$, where $T$ is the kinetic energy of the particle.
This estimate of the energy is then compared with that derived from the momentum measurements made using track curvature under the assumption that the particle is a proton or a pion.
The closer of these two values to the reconstructed ECAL energy determines the reconstructed particle type.

Neutral pions are considered to be reconstructed if both decay photons have energies of more than \SI{50}{\MeV} and the angle between the two photons is larger than 0.01~radians (i.e. they do not lie on top of one another).
It is assumed that for photons $\sigma_{E}/E = 0.1$.

Finally, a degree of confusion between muons and charged pions is implemented.
If the highest momentum muon or charged pion is a muon then the particle is correctly identified.
However, if a charged pion has a higher momentum there is a chance for the particle to be incorrectly reconstructed as a muon.
If the charged pion has a momentum of less than \SI{0.4}{\GeV\per\clight} it is assumed that it can be correctly identified from its range within the TPC.
For pions in the energy range $\SI{0.4}{\GeV\per\clight} < p < \SI{1.0}{\GeV\per\clight}$ the probability to interact in the ECAL is determined from \citefig{fig:interactionSpline}.
If a particle interacts in the ECAL it is reconstructed as a pion.

\begin{figure}[h]
	\centering
	\begin{adjustbox}{max totalsize=.6\linewidth, center}
		\input{files/figures/dune_ndrwt/interactionSpline}
	\end{adjustbox}
	\caption[Interaction probability for a charged pion travelling through the ND-GAr ECAL as a function of momentum]{Interaction probability for a charged pion travelling through the ND-GAr ECAL as a function of momentum.}
	\label{fig:interactionSpline}
\end{figure}



\section{Measurements of pion multiplicity}
\label{sec:dune_ndrwt:pionMulti}

%%% Methods here


\subsection{Gaseous argon}

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/confusionCatFhc}
		\end{adjustbox}
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/confusionCatRhc}
		\end{adjustbox}
	\end{minipage}
	\caption[Confusion matrices for pion multiplicities in ND-GAr]{Left: Confusion matrix for pion multiplicities in ND-GAr with the neutrino beam in FHC mode. Right: Confusion matrix for pion multiplicities in ND-GAr with the neutrino beam in RHC mode.}
	\label{fig:confusMatPi}
\end{figure}

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hsFhcQ2Reco_spread}
		\end{adjustbox}
	\end{minipage}
 	\hfill
 	\begin{minipage}[t]{.5\linewidth}
 		\begin{adjustbox}{max totalsize=\linewidth, center}
 			\input{files/figures/dune_ndrwt/hsFhcQ2Vis}
 		\end{adjustbox}
 	\end{minipage}
 	\caption[Comparison of NuWro and GENIE in $Q^{2}_{\textrm{vis}}$ for FHC]{Ratio of NuWro to GENIE event rates in ND-GAr as a function of $Q^{2}_{\textrm{vis}}$ with the beam in FHC mode. Left: Reconstructed selection. Right: True selection.}
 	\label{fig:Q2CompFhc}
\end{figure}

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hsRhcQ2Reco_spread}
		\end{adjustbox}
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hsRhcQ2Vis}
		\end{adjustbox}
	\end{minipage}
	\caption[Comparison of NuWro and GENIE in $Q^{2}_{\textrm{vis}}$ for RHC]{Ratio of NuWro to GENIE event rates in ND-GAr as a function of $Q^{2}_{\textrm{vis}}$ with the beam in RHC mode. Left: Reconstructed selection. Right: True selection.}
	\label{fig:Q2CompRhc}
\end{figure}

\subsection{Liquid argon}

\section{Near detector-driven reweighting}

\subsection{Choice of variables}

Two variables are defined in which the reweighting takes place, the visible energy transfer and the visible momentum transfer. 
These variables are termed \evis and \pvis respectively.
\evis is defined as 
\begin{equation}
	\evis = T_{\textrm{p}} + E_{\pi}
\end{equation}
where $T_{\textrm{p}}$ is the total kinetic energy of any final state protons and $E_{\pi}$ is the total energy (including rest masses) of any final state pions.
One can see that any energy carried by neutrons is not measured in this definition.

\pvis is defined as
\begin{equation}
	\pvis = \sqrt{ 2(\evis + E_{\mu})(E_{\mu} - p_{\mu}\cos\theta_{\mu}) - m_{\mu}^{2} + \evis^{2} }
\end{equation}
where $E_{\mu}$ and $p_{\mu}$ are the energy and momentum of the outgoing muon.
$\theta_{\mu}$ is the angle between the outgoing muon and incoming neutrino.

Distributions of true vs. reconstructed \evis and \pvis are shown in \citefig{fig:visibleTrueReco}.
One can clearly see that in both cases, the distributions are highly diagonal.

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/q0CompFhc}
		\end{adjustbox}	
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/q3CompFhc}
		\end{adjustbox}
	\end{minipage}
	\caption[True vs. reconstructed \evis (left) and \pvis (right)]{2-dimensional distributions showing relationship between true and reconstructed \evis (left) and \pvis (right). In both cases the distributions are area normalised to 1.}
	\label{fig:visibleTrueReco}
\end{figure}

Examples of 2-dimensional distributions of these quantities for various reconstructed final states are shown in \citefig{fig:q0q3Genie}.
One can observe substantial variations in the distributions as a function of final state.

\begin{figure}[t]
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat7_genie}
		\end{adjustbox}
		\caption{$0\pi$ - 1 proton}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat8_genie}
		\end{adjustbox}
		\caption{$0\pi$ - $>1$ proton}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat3_genie}
		\end{adjustbox}
		\caption{$1\piplus$}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat4_genie}
		\end{adjustbox}
		\caption{$1\pizero$}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat5_genie}
		\end{adjustbox}
		\caption{$2\pi$}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3FhcCat6_genie}
		\end{adjustbox}
		\caption{$>2\pi$}
	\end{subfigure}
	\caption[Two dimensional distributions of $E_{\text{vis}}$ and $p_{\text{vis}}$ in ND-GAr]{Two dimensional distributions of reconstructed $E_{\text{vis}}$ and $p_{\text{vis}}$ in ND-GAr, separated out by final state.}
	\label{fig:q0q3Genie}
\end{figure}

The same distributions as those displayed in \citefig{fig:q0q3Genie} are plotted for the NuWro mock data.
The ratio of these two distributions is then taken.
That is the number of events in each bin for the mock data sample is divided by the number of events in the same bin for the nominal sample.
These ratios are shown for FHC in \citefig{fig:q0q3RatioFhc}.

\begin{figure}[t]
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat7_ratio}
		\end{adjustbox}
		\caption{$0\pi$ - 1 proton}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat8_ratio}
		\end{adjustbox}
		\caption{$0\pi$ - $>1$ proton}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat3_ratio}
		\end{adjustbox}
		\caption{$1\piplus$}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat4_ratio}
		\end{adjustbox}
		\caption{$1\pizero$}
	\end{subfigure} \\
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat5_ratio}
		\end{adjustbox}
		\caption{$2\pi$}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/dune_ndrwt/hq0q3RecoFhcCat6_ratio}
		\end{adjustbox}
		\caption{$>2\pi$}
	\end{subfigure}
	\caption[Two dimensional distributions of \evis and \pvis in ND-GAr]{Two dimensional distributions of reconstructed \evis and \pvis in ND-GAr, separated out by pion multiplicity.}
	\label{fig:q0q3RatioFhc}
\end{figure}


