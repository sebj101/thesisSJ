\chapter{Measurements of the CERN T10 beam flux}
\label{sec:hptpc_beam_flux}

\section{Motivation}
\label{sec:hptpc_beam_flux:motivation}

As mentioned in \citesec{sec:theory:currentState}, one of the targets of the next generation of long baseline neutrino oscillation experiments is the measurement of \dcp.
In order to make this measurement, systematic uncertainties will have to be significantly reduced.
In the current generation of neutrino oscillation experiments, uncertainties relating to the neutrino-nucleus interaction model make up a large part of the overall systematic budget.
For example, NOvA's most recent results assign systematic uncertainties from its interaction model of $3.2-5.8\%$ on its \nue and \anue signal rates~\cite{novaRecent}.
The T2K experiment has reported systematic uncertainties of $7-9\%$ on the rate of far detector electron-like events (after the near detector constraint has been applied) where cross-section uncertainties are the largest part of this~\cite{t2kRecent}.

Reducing these systematic uncertainties relies upon better modelling of neutrino-nucleus interactions.
It is also important to have an accurate interaction model in order to infer the neutrino energy from the observed events.
A illustrative diagram showcasing the dependence on the interaction model is shown in \citefig{fig:fsiDiag}.

\begin{figure}[h]
  \centering
  \includegraphics[width=\linewidth]{files/figures/hptpc_beam_flux/fsiDiag}
  \caption[Simplified diagram of nuclear effects in neutrino nucleus interactions]{Simplified diagram of nuclear effects in neutrino nucleus interactions for a hypothetical quasielastic \numu interaction. Taken from~\cite{nuisanceTalk}.}
  \label{fig:fsiDiag}
\end{figure}

As \citefig{fig:fsiDiag} shows, in the simplest case a neutrino nucleus interaction (in this case a CC quasi-elastic one) can be thought of as a neutrino interacting with a free nucleon.
However, within a nucleus the nucleons are not static -- they have some initial momentum which will modify the kinematics of the outgoing particle.
Additionally within a nucleus, additional effects can occur due to correlations between nucleons.
Finally, as the outgoing particles propagate through the nucleus they can interact with other nucleons.
These `final state interactions' (FSI) can modify both the outgoing particles and their kinematics.

Given that in a detector only the outgoing particles can be observed, we are reliant on neutrino interaction models of the initial nuclear state, nuclear effects and FSI in order to correctly reconstruct the neutrino energy.
For example, at the DUNE experiment the primary neutrino interaction type is resonant single pion production, caused by the interaction of a neutrino with a nucleon within an argon nucleus.
This can be represented for muon neutrinos as
\begin{align}
  \numu + p &\rightarrow \muminus + \Delta^{++} \rightarrow \muminus + p + \piplus \\
  \numu + n &\rightarrow \muminus + \Delta^{+} \rightarrow \muminus + n + \piplus \\
  \numu + n &\rightarrow \muminus + \Delta^{+} \rightarrow \muminus + p + \pizero \, .
\end{align}

However, the pions emitted in this process can interact with other nucleons as they progress through the nucleus, leading to their absorption.
If this occurs, the outgoing pion will not be detected and the reconstructed hadronic energy will be biased by the mass of the pion.

Models of final state interactions are not consistent between different neutrino interaction generators.
Of the most commonly used neutrino interaction generators, GENIE~\cite{genie}, NuWro~\cite{nuwro} and NEUT~\cite{neut} all model FSI using intranuclear cascade models tuned on external hadron-nucleus scattering data.
The generator GiBUU~\cite{gibuu} meanwhile, solves the semi-classical Boltzmann-Uehling-Uhlenbeck equation in order to simulate FSI.

However, proton-nucleus scattering measurements are either sparse or non-existent in the energy region of interest or on the desired nucleus.
This is shown in \citefig{fig:protonNucleus} which compares data with a semi-empirical model.
One can see that, for several of the displayed nuclei, large energy regions have no measurements.
This lack of data leads to different parametrisations being used by different neutrino interaction generators.

\begin{figure}[h]
  \centering
  \includegraphics[width=.8\linewidth]{files/figures/hptpc_beam_flux/DataProtonCrossSections}
  \caption[Proton-nucleus cross-section data compared with a semi-empirical model]{Total reaction cross-sections for protons on a variety of nuclei. The points represent data from~\cite{protonXSecData} while the curves are a semi-empirical model~\cite{protonXSecModel}. Figure from~\cite{hptpcProposal}.}
  \label{fig:protonNucleus}
\end{figure}

\citefig{fig:generatorProtons} shows that these differing parametrisations can lead to discrepant final state kinematics between the generators, particularly at low proton energies.
\citefig{fig:generatorProtons} also shows that much of the discrepancy lies below the proton track production threshold in liquid argon.
Mismodelling of these nuclear effects can lead to significant biases in the measurement of neutrino oscillation parameters~\cite{nuclearMismodelOsc}, an undesirable outcome for future long baseline experiments.

High pressure gas TPCs (HPgTPCs) provide an excellent opportunity to gather proton-nucleus data in these regions of very low proton energy due to low thresholds required for track reconstruction.
To this end, a HPgTPC prototype has been constructed and exposed to a charged particle beam at CERN.
In order to access a flux of low energy protons, the beam was moderated and the HPgTPC was placed in an off-axis position. 
An overview of the beam test is given in \citesec{sec:hptpc_beam_flux:overview} while measurements of the beam flux are presented in \citesec{sec:hptpc_beam_flux:results}

\section{The 2018 beam test}
\label{sec:hptpc_beam_flux:overview}

\subsection{The T10 beamline}
\label{sec:hptpc_beam_flux:overview:t10}

The beam test took place at the T10 beam line in the East Area at CERN.
The T10 beam is derived from the PS beam, consists primarily of protons, charged pions and electrons and has a momentum range of \SIrange{0.8}{6.5}{\giga\electronvolt\per\clight} (corresponds to a proton kinetic energy range of \SIrange{0.3}{5.6}{\giga\electronvolt})~\cite{t10Report}.

\citefig{fig:t10Calc} shows the calculated intensity of the T10 beam as a function of beam momentum, separated by particle species.
One can see that charged pions dominate at all momenta, with the effect becoming more pronounced at lower beam momenta.

\begin{figure}[h]
  \centering
  \includegraphics[width=.6\linewidth]{files/figures/hptpc_beam_flux/t10Comp}
  \caption[Calculated intensity of the CERN T10 beam as a function of selected beam momentum and particle species.]{Calculated intensity of the CERN T10 beam as a function of selected beam momentum and particle species, from~\cite{t10Report}.}
  \label{fig:t10Calc}
\end{figure}

\citefig{fig:unmoderatedBeam}, left, shows the time of flight spectrum for the unmoderated T10 beam at a momentum setting of \SI{0.8}{\giga\electronvolt\per\clight}.
In this case the baseline is \SI{10.8}{\metre}.
Within \citefig{fig:unmoderatedBeam}, left, there are several peaks caused by different particle species, including protons.
The particle identification process will be covered in more detail in \citesec{sec:hptpc_beam_flux:methods}.
One can see from \citefig{fig:unmoderatedBeam}, right, that even at this momentum setting there is a negligible flux of protons with kinetic energies of less than \SI{0.1}{\giga\electronvolt}.

\begin{figure}[h]
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/utofNoBend}
    \end{adjustbox}
  \end{minipage}
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/protonKeNoBend}
    \end{adjustbox}
  \end{minipage}
  \caption[Time of flight spectrum and proton kinetic energy for the unmoderated and unbent T10 beam]{Left: Time of flight spectrum of the unmoderated and unbent CERN T10 beam across a baseline of \SI{10.8}{\metre}. Right: Measured kinetic energies of protons in the unmoderated and unbent CERN T10 beam.}
  \label{fig:unmoderatedBeam}
\end{figure}

It is necessary to modify the T10 beam for several reasons, one of them being the lack of the low energy protons.
Additionally, it is important to reduce the multiplicity of particles entering the HPgTPC due to the speed of the optical readout which could otherwise become overwhelmed.
Finally, it is desirable to modify the proton-minimum ionising particle (MIP) ratio in order to isolate more particles which are of interest to a cross-section analysis.

Therefore, two modification are made to the beam flux in order to achieve these goals.
Firstly up to four \SI{10 x 10 x 10}{\cm} acrylic moderator blocks are placed in the beam.
These blocks have the effect of scattering the incident particles and reducing their energy.
Additionally, the HPgTPC is moved to an off-axis angle in order to maximise the ratio of protons to MIPs.
From previous GEANT~\cite{geant} simulations it is determined that the optimal off-axis angle for the HPgTPC is between \ang{2} and \ang{3}.
However, due to space constraints in the beam hall, the HPgTPC could not be moved this far off-axis.
Instead, the beam was steered approximately \ang{1} off its nominal axis to increase the angle between the beam and the HPgTPC.
A bird's-eye view diagram of the experimental setup, which shows the beam position relative to the HPgTPC, is shown in \citefig{fig:beamSetup}.

\begin{figure}[h]
  \centering
  \includegraphics[width=\linewidth]{files/figures/hptpc_beam_flux/hptpc_t10_planview}
  \caption[Bird's-eye view of the experimental setup within the T10 beam area]{Bird's-eye view of the experimental setup within the T10 beam area, from~\cite{beampaper}.}
  \label{fig:beamSetup}
\end{figure}

The effectiveness of this off-axis technique was assessed using several timing points which were used to measure the particle species and energies upstream and downstream of the HPgTPC prototype.
These timing points are shown in \citefig{fig:beamSetup} and, from upstream to downstream, consist of:
\begin{itemize}
    \item \SOne, a \SI{40 x 40 x 5}{\mm} plastic scintillator cross, described in \citesec{sec:hptpc_beam_flux:overview:s1s2};
    \item \STwo, a \SI{120 x 120 x 5}{\mm} plastic scintillator tile, used for coincidence measurements with \SOne, described in \citesec{sec:hptpc_beam_flux:overview:s1s2};
    \item \SThree, a large panel of plastic scintillator bars placed directly upstream of the TPC vessel, described in \citesec{sec:hptpc_beam_flux:overview:s3};
    \item \SFour, a large panel of plastic scintillator bars placed directly downstream of the HPgTPC, which is described in \citesec{sec:hptpc_beam_flux:overview:s4} (its characterisation is described in \citesec{sec:hptpc_dtof_characterisation}).
\end{itemize}
The moderator blocks were placed on a tripod stand in between \SOne and \STwo.

\subsection{Survey and coordinate system}
\label{sec:hptpc_beam_flux:overview:survey}

The distances to the various objects in the beamline from an origin point is measured by the CERN Survey, Mechatronics and Measurements (SMM) group to a precision of \SI{0.5}{\mm}.
Specifically, multiple points on each of \SOne, \STwo, \SThree, \SFour and the HPgTPC prototype were measured.
From these measurements, the distance between various timing points is calculated and displayed in \citetab{tab:pointDistances}, calculated using this survey data

\begin{table}
  \centering
  \caption[Calculated distances between objects within the T10 beamline during the beam test]{Calculated distances between objects within the T10 beamline during the beam test}
  \label{tab:pointDistances}
  \begin{tabular}{c c}
    \hline
    \hline
    Points & Distance between centres / m \\
    \hline
    $\text{Beam monitor} - \SOne$ & \num{0.288(1)} \\
    $\SOne - \STwo$ & \num{1.419(1)} \\
    $\SOne - \SThree$ & \num{10.756(1)} \\
    $\SThree - \text{TPC US side}$ & \num{1.323(2)} \\
    $\text{TPC DS side} - \SFour$ & \num{0.918(2)} \\
    $\STwo - \SFour$ & \num{12.651(1)} \\
    \hline
  \end{tabular}
\end{table}

The coordinate systeam used in this analysis is a right-handed coordinate system defined by the following directions: the $+\hat{z}$ direction is defined as the nominal beam axis, the $+\hat{y}$ direction is defined as vertically upwards and the $\hat{x}$ direction is defined as the horizontal direction which is perpendicular to the beam direction.
The origin is take to be at \SOne.
The $\hat{x}$ and $\hat{z}$ axes are labelled in \citefig{fig:beamSetup}.
In this analysis, the results are given in terms of the angles $\theta$ and $\phi$.
$\theta$ is measured in the $\hat{x}-\hat{z}$ plane with positive angle measured in the $+\hat{x}$ direction while $\phi$ is measured in the $\hat{y}-\hat{z}$ with positive angles measured in the $+\hat{y}$ direction.

\citefig{fig:angDistS1} shows the angular distribution of objects within the beamline as viewed from \SOne.
\citetab{tab:angDistS1} shows the angular extent of various beamline components as measured from \SOne.
Both of these use the data from the survey in order to calculate the results.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=.8\textwidth, center}
    \input{files/figures/hptpc_beam_flux/angDistS1}
  \end{adjustbox}
  \caption[Angular distribution of objects in the T10 beamline]{Angular distribution of objects within the T10 beamline. The origin here is at \SOne.}
  \label{fig:angDistS1}
\end{figure}

\begin{table}
  \centering
  \caption[Angular extent of components within the T10 beamline with \SOne as the origin]{Angular extent of components within the T10 beamline with \SOne as the origin.}
  \label{tab:angDistS1}
  \begin{tabular}{c c c c c}
    \hline
    \hline
    Object & $\theta_{\text{min}}$ & $\theta_{\text{max}}$ & $\phi_{\text{min}}$ & $\theta_{\text{max}}$ \\
    \hline
    \STwo & $\ang{-3.96} \pm \ang{0.03}$ & $\ang{0.36} \pm \ang{0.03}$ & $\ang{-2.01} \pm \ang{0.03}$ & $\ang{2.94} \pm \ang{0.03}$\\
    \SThree & $\ang{-5.923} \pm \ang{0.004}$ & $\ang{3.040} \pm \ang{0.004}$ & $\ang{-3.215} \pm \ang{0.004}$ & $\ang{3.344} \pm \ang{0.004}$ \\
    \SFour & $\ang{-6.083} \pm \ang{0.003}$ & $\ang{-0.401} \pm \ang{0.003}$ & $\ang{-1.426} \pm \ang{0.003}$ & $\ang{1.771} \pm \ang{0.003}$ \\
    TPC US face & $\ang{-3.59} \pm \ang{0.01}$ & $\ang{-1.44} \pm \ang{0.01}$ & $\ang{-2.66} \pm \ang{0.01}$ & $\ang{2.58} \pm \ang{0.01}$ \\
    TPC DS face & $\ang{-3.778} \pm \ang{0.009}$ & $\ang{-1.806} \pm \ang{0.009}$ & $\ang{-2.440} \pm \ang{0.009}$ & $\ang{2.361} \pm \ang{0.009}$ \\
    \hline 
  \end{tabular}
\end{table}

\citefig{fig:beamlinePics} shows images of the beamline with the various components of the ToF systems as well as the HPTPC and moderator blocks labelled.
In this particular image, all four moderator blocks are placed on the tripod stand.

\begin{figure}[h]
  \centering
  \includegraphics[width=\linewidth]{files/figures/hptpc_beam_flux/S1S2S3S4}
  \caption[Images of the test beam setup with various objects labelled]{Images of the T10 beamline with the apparatus used in the beam test labelled. Left: the downstream part of the beamline. Right: The upstream part of the beamline. Image from~\cite{beampaper}.}
  \label{fig:beamlinePics}
\end{figure}

\SThree and \SFour each have their own independent DAQ systems which process data from \SOne and \STwo plus either \SThree or \SFour.
The data from these two systems is synchronised offline using a signal from the PS indicating the arrival of a beam spill which is recorded by both DAQs.

T10 receives $1-3$ spills from the PS every supercycle, which has a normal duration of \SI{33}{\second}.
The duration of each of these spills is approximately \SI{0.4}{\second}.
The minimum separation in time of these spills is \SI{1}{\second} which means that the beam spill arrival signal has a frequency of less than \SI{1}{\hertz}.
This means that spills in the two DAQs can be matched by using this signal in combination with the DAQ file timestamps.

\citetab{tab:nSpills} shows the number of recorded spills used for each moderator block configuration for the variable block analysis.
One can see that significantly more spills are recorded in the 4 block configuration.
This is because this is the configuration that was used for the majority of the beam test.

\begin{table}
  \centering
  \caption[Number of recorded spills for each moderator block configuration used in T10 beam flux analysis]{Number of recorded spills for each moderator block configuration used in T10 beam flux analysis}
  \label{tab:nSpills}
  \begin{tabular}{c c}
    \hline
    \hline
    Number of moderator blocks & Recorded spills \\
    \hline
    0 & 257 \\
    1 & 254 \\
    2 & 267 \\
    3 & 220 \\
    4 & 3884 \\
    \hline
  \end{tabular}
\end{table}

\subsection{The upstream beam counters (\SOne and \STwo)}
\label{sec:hptpc_beam_flux:overview:s1s2}

The \SOne beam counter consists of a cross formed from two pieces of plastic scintillator and is shown in the left hand image of \citefig{fig:s1s2Pic}.
This cross measures \SI{40 x 40 x 5}{\milli\metre} and is attached to four 1'' Hamamatsu Photonics R4998 PMTs at each end which are used to read out the light signals.

\begin{figure}[h]
  \centering
  \includegraphics[width=.7\linewidth]{files/figures/hptpc_beam_flux/S1S2FrontOn}
  \caption[The upstream beam counters \SOne and \STwo]{Images of the upstream beam counters \SOne (left) and \STwo (right) from~\cite{beampaper}.}
  \label{fig:s1s2Pic}
\end{figure}

The time resolution of the \SOne beam counter is measured using the DAQ of the upstream ToF and found to be around \SI{30}{\pico\second}.
This measurement is made by taking the average distribution of the four PMT hit times. However, because this measurement is not centred at zero, we instead calculate the quantity
\begin{equation}
  t_{\text{ave}} = \frac{1}{4} ((t_{\text{PMT1}}+t_{\text{PMT2}}) - (t_{\text{PMT3}}+t_{\text{PMT4}}))
  \label{eq:tAve}
\end{equation}
where the $t_{\text{PMT}n}$ refer to the four PMTs used to read out \SOne.
This quantity has the same spread as the average hit time but is centred at zero.
An example of the distribution produced is shown in \citefig{fig:s1Res} which contains the data from one run.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=.7\textwidth, center}
    \input{files/figures/hptpc_beam_flux/s1TimeRes}
  \end{adjustbox}
  \caption[Example of \SOne time resolution measurement]{An example of an \SOne time resolution measurement made using the quantity $t_{\text{ave}}$, defined in \citeeq{eq:tAve}.}
  \label{fig:s1Res}
\end{figure}

\STwo consists of a single piece of plastic scintillator, measuring \SI{120 x 120 x 5}{\milli\metre} which is read out, via a light guide, by a 2'' Hamamatsu Photonics R1309 PMT~\cite{hamamatsu}.
An image of \STwo is shown on the right of \citefig{fig:s1s2Pic} where the light guide is also indicated.
\STwo is situated \SI{1.419(1)}{\metre} downstream of \SOne and away from the nominal beam axis.
This off-axis positioning means that all of the beam particles impinging on the HPgTPC should pass through \STwo.

The analog signals produced by the PMTs in \SOne and \STwo are fed into LeCroy 620AL NIM discriminator units with a threshold of \SI{30}{\milli\volt}.
These discriminated signals were then fed into a NIM coincidence unit.
The output of this unit was recorded by the DAQ system of the downstream time of flight panel (\SFour).
The signals from \SOne and \STwo were fed individually into the DAQ system of the upstream time of flight panel (\SThree).

\subsection{The upstream time of flight detector (\SThree)}
\label{sec:hptpc_beam_flux:overview:s3}

\SThree (also referred to as the upstream time of flight system) is situated \SI{1.323(2)}{\metre} upstream of the upstream side of the TPC and \SI{10.756(1)}{\metre} in the beamline.
It consists of 22 bars of EJ-200~\cite{ej200} plastic scintillator.
20 of these bars measure \SI{168 x 6 x 1}{\centi\metre} while the remaining 2 measure \SI{150 x 6 x 1}{\centi\metre}~\cite{s3Paper}.
The bars are arranged in a staggered setup with an overlap between the bars of \SI{5}{\milli\metre} while the two smaller bars are placed at the top and bottom of the panel.
The total active area of the detector is \SI{2.0214}{\centi\metre\square}.
Schematic diagrams of \SThree are shown in \citefig{fig:s3Diag} along with dimensions.

\begin{figure}[h]
  \begin{minipage}[t]{.55\linewidth}
    \includegraphics[width=\linewidth]{files/figures/hptpc_beam_flux/uToF_sketch}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.41\linewidth}
    \includegraphics[width=\linewidth]{files/figures/hptpc_beam_flux/uTOF_rot}
  \end{minipage}
  \caption[Schematic diagrams of \SThree]{Front-on and rotated schematic diagrams of \SThree from~\cite{s3Paper} along with dimensions.}
  \label{fig:s3Diag}
\end{figure}

EJ-200 plastic scintillator (of which the bars are made) has a brightness of \num{10000}~photons/MeV deposited.
Additionally, it has a large optical attenuation length (\SI{4}{\metre}) along with a fast rise time and decay time constant (\SI{0.9}{\nano\second} and \SI{2.1}{\nano\second} respectively.
The scintillation emission spectrum peaks at a wavelength of \SI{435}{\nano\metre}~\cite{ej200}.
In order to increase the light collection capabilities of the bars while excluding background light, they are wrapped in aluminium foil which has a reflectivity of 60\%.

The scintillation photons produced by the bars are detected by S13360-6050PE Hamamatsu Photonics~\cite{hamamatsu} silicon photomultipliers (SiPMs) arranged at either end of the bar.
These photosensors, each measuring \SI{6 x 6}{\milli\metre}, are arranged in groups of eight and then coupled to the end of the bar.
These photomultipliers have a wavelength range that is well suited to the scintillation light produced by the bars (the sensitivity of the SiPMs at a wavelength of \SI{450}{\nano\metre} is 40\%~\cite{hamamatsu}).
The anode signals produced by these SiPMs are read out, summed and shaped by a dedicated circuit as described in~\cite{s3SiPM}.

These signals, along with those from \SOne and \STwo, are then fed into a DAQ based upon the SAMPIC chip, further details of which are given in~\cite{sampic}.

\SThree triggers are formed in the following manner, shown graphically in \citefig{fig:s3Trigger}, and are intended to identify the prescence of a beam particle travelling between \SOne and \SThree.
An \SOne signal is considered to have occurred when at least three of the four \SOne PMTs register a signal above the threshold of \SI{30}{\milli\volt}.
An \SThree signal is deemed to have occurred if the SiPMs on either end of a given bar register a signal above a threshold of \SI{30}{\milli\volt}.
If an \SOne signal and an \SThree signal occur within a time window of \SI{70}{\nano\second}, the DAQ is triggered and writes the event.
The DAQ also acquires signals from the coincidence of \SOne and \STwo as well as the signal indicating the start of the beam spill.

\begin{figure}[h]
  \centering
  \includegraphics[width=.8\linewidth]{files/figures/hptpc_beam_flux/utofTrig}
  \caption[Trigger logic for the upstream time of flight DAQ]{Trigger logic showing the necessary conditions for the identification of a $\SOne-\SThree$ beam particle by the upstream ToF DAQ.}
  \label{fig:s3Trigger}
\end{figure}


\subsection{The downstream time of flight detector (\SFour)}
\label{sec:hptpc_beam_flux:overview:s4}

The design of \SFour is primarily discussed in \citesec{sec:hptpc_dtof_characterisation:dtof}, however it will be briefly revisited here.
\SFour consists of 10 scintillator bars which together form an active area of \SI{1.40 x 0.78}{\metre}.
A diagram of one such bar is shown in \citefig{fig:barDiag}.
Each of these scintillator bars has a PMT attached to each end and these observe the scintillation light produced by charged particles traversing the bars.
A diagram of \SFour is shown in \citefig{fig:dtofDiag}.

The anode signal of each of the PMTs is fed into a LeCroy 620AL NIM discriminator with a threshold of \SI{-20}{\milli\volt}.
Any PMT signals above this threshold are digitised using a time-to-digital converted (TDC)
Additionally, the signal indicating the start of a beam spill as well as a signal indicating a coincidence between \SOne and \STwo were fed into the TDC.
A particle (either beam induced or otherwise) is considered to have been observed in \SFour if a signal above the discriminator threshold is recorded in both PMTs on the same bar, within \SI{20}{\nano\second} of each other.

Unlike the UToF DAQ system, the DToF DAQ is operated in self-triggering mode and thus acquired data both inside and outside the beam spill.


\subsection{The HPTPC prototype}
\label{sec:hptpc_beam_flux:overview:hptpc}

The relevant specifications of the HPTPC prototype for this study are the location and wall thickness of the pressure vessel.
The upstream face of HPTPC is located \SI{1.323(2)}{\metre} downstream of the \SThree panel while the downstream face is located \SI{0.918(2)}{\metre} upstream of \SFour.
\citefig{fig:angDistS1} shows that, from the point of view of the beam, most of the  TPC volume is covered by \STwo, \SThree and \SFour.
The angular position of the TPC is at approximately $\theta = \ang{-2.5}$.
With the beam steering, this means that the centre of the TPC lies approximately \ang{3.5} off-axis.

The pressure vessel itself is made out of 304L stainless steel, has an outer diameter of \SI{142}{\centi\metre} and a vessel wall thickness of \SI{1}{\centi\metre}~\cite{deisting2021high}.
This vessel wall thickness is equivalent to the range of proton with a kinetic energy of roughly \SI{80}{\mega\electronvolt}~\cite{protonRangeTables}.

The main cylindrical body of the vessel is \SI{73.6}{\centi\metre} in length while the rounded sections at the end of this volume each have a length of \SI{32.5}{\centi\metre}~\cite{deisting2021high}.
Interior to the cylindrical body is the active volume of the TPC.
This active TPC volume measures \SI{111}{\centi\metre} in diameter and \SI{48}{\centi\metre} in the drift direction and is formed by a series of copper rings which make up the field cage.
A diagram of the HPTPC, showing a cross-sectional view of the active volume, is shown in \citefig{fig:hptpc}.

\begin{figure}[h]
  \centering
  \includegraphics[width=.7\linewidth]{files/figures/hptpc_beam_flux/vesselView}
  \caption[Cross-sectional view of the HPTPC prototype]{Cross-sectional view of the HPTPC prototype with the door open, from~\cite{beampaper}. The drift volume formed by the copper rings is clearly visible. The direction of the beam during the beam test is indicated.}
  \label{fig:hptpc}
\end{figure}

\section{Methods}
\label{sec:hptpc_beam_flux:methods}

In a beamline such as the T10 beamline at CERN, charged particles are selected using by momentum using a magnetic field.
This results in a beam of particles that are all of the same momentum but of different species.
Different particles of the same momentum will take different times to cover the same distance.
The time of flight, $t$, of a particle of mass, $m$, with a momentum, $p$, is given by
\begin{equation}
  t = L \sqrt{ \frac{1}{c^{2}} + \frac{m^{2}}{p^{2}} }\, ,
  \label{eq:tof}
\end{equation}
where $L$ is the distance travelled by the particle.
\citefig{fig:tofVsMom}, left and right, show the time of flight for various particles as a function of particle momentum for the $\SOne - \SThree$ and  $\STwo - \SFour$ distances respectively.
If the beam momentum is known, by measuring a particle's time of flight it should be possible to identify the particle in question.
One can see that, assuming a time resolution of around \SI{1}{\nano\second}, it should be possible to distinguish between deuterons, protons and pions/muons at the momenta used in this study.

\begin{figure}[h]
  \begin{minipage}[t]{.5\linewidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/s1s3Times}
    \end{adjustbox}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.5\linewidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/s2s4Times}
    \end{adjustbox}
  \end{minipage}
  \caption[Predicted time of flight as a function of momentum for various particle types across the distances used in the HPgTPC beam test]{Predicted time of flight as a function of momentum for various particle types across the distances used in the HPgTPC beam test. Right: the $\SOne - \SThree$ distance. Left: the $\STwo - \SFour$ distance.}
  \label{fig:tofVsMom}
\end{figure}

The basic methods by which the time of flight systems are calibrated are discussed in \citesec{sec:hptpc_beam_flux:methods:general}.
The process used for the identification of particles in \SThree as well as corrections specific to \SThree are discussed in \citesec{sec:hptpc_beam_flux:methods:s3} while the same topics involving \SFour are discussed in \citesec{sec:hptpc_beam_flux:methods:s4}.

\subsection{Analysis methods}
\label{sec:hptpc_beam_flux:methods:general}

In this study two measurements of the beam flux are made, one with \SThree and one with \SFour.
In both cases we measure the time of flight of particle $t_{f}-t_{i}$ where $t_{i}$ is time at which the particle is detected at the initial upstream timing point and $t_{f}$ is the time at which the particle is detected at some final downstream timing point.
In the case of the UToF system, the measured time difference is $t_{\SThree} - t_{\SOne}$, while for the DToF system it is $t_{\SFour} - t_{\STwo}$.

The particular particle type distinction that is made in this study is between protons and MIPs.
At the momenta and with the beamline used in this study, MIPs are primarily charged pions and electrons.
At a momentum of \SI{0.8}{\giga\electronvolt\per\clight} a charged pion will take \SI{36.4}{\nano\second} to traverse the $\SOne - \SThree$ distance while a proton will take \SI{55.3}{\nano\second}.
At the same momentum, a charged pion will take \SI{42.8}{\nano\second} to travel the $\STwo - \SFour$ distance while a proton will take \SI{65.0}{\nano\second}.

Example time of flight spectra are shown in \citefig{fig:s3Tof}, divided between the various moderator block configurations.
Here one can see that there are two distinct populations, a faster peak situated at approximately \SI{36}{\nano\second}, caused by MIPs (primarily pions, muons and positrons) and a broader double peaked structure located between \SI{50}{\nano\second} and \SI{110}{\nano\second} which is caused by protons.
One can see that these positions agree with the theoretical expectation above.

\citefig{fig:s3Tof} also shows that the proton population has a distinct double peaked structure.
This is caused by the steering of the beam which was undertaken in order to increase the off-axis angle of the HPgTPC.
This steering in turn leads to a portion of the beam scattering in the steering magnets.
This scattered portion of the beam forms the slower, broader proton peak while the unscattered portion forms the quicker proton peak.

The 0 block sample also contains a third peak located at approximately \SI{95}{\nano\second} which is not visible in the other samples.
This is caused by deuterons which are moderated out in the other samples.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize={.8\linewidth}, center}
    \input{files/figures/hptpc_beam_flux/utofS1}
  \end{adjustbox}
  \caption[Time of flight spectra for particles travelling between \SOne and \SThree for various numbers of moderator blocks]{Time of flight spectra for particles travelling between \SOne and \SThree for various numbers of moderator blocks}
  \label{fig:s3Tof}
\end{figure}

In this study, in order to identify the species of particle detected it is important to measure the time of flight of said given particle accurately.
With that in mind, it is important to calibrate the equipment used for cabling and equipment delays.
This is done by shifting the value of $t_{f}-t_{i}$ such that, for the unmoderated beam, the MIP peak is located at its expected value according to \citeeq{eq:tof}.
This procedure is performed for each ToF DAQs.
The resulting required shift for $t_{\SThree} - t_{\SOne}$ is \SI{65.0}{\nano\second} while for $t_{\SFour} - t_{\STwo}$ the required shift is \SI{43.7}{\nano\second}.

\subsection{\SThree specific methods}
\label{sec:hptpc_beam_flux:methods:s3}

One can see that the calibration has been performed correctly for \SThree in \citefig{fig:s3MassDistribution} which shows the reconstructed mass spectrum for the unmoderated beam.
This distribution is formed using the following equation:
\begin{equation}
  m^{2} = p^{2} \left( \left( \frac{t_{\SThree} - t_{\SOne}}{x_{\SThree} - x_{\SOne}} \right)^{2} - 1 \right) \, ,
  \label{eq:massDistribution}
\end{equation}
where $p$ has been set to \SI{0.8}{\giga\electronvolt\per\clight} and $x_{\SThree} - x_{\SOne}$ is equal to the distance between \SOne and \SThree.
One can observe that the predicted particle positions match well with the data.
Additionally, one can see that the MIP portion of the beam is made up predominantly of positrons, with a smaller component made up on pions.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=\textwidth, center}
    \input{files/figures/hptpc_beam_flux/s3TofMass}
  \end{adjustbox}
  \caption[Reconstructed mass spectrum for \SThree]{Reconstructed mass spectrum for \SThree for the data taken without moderator blocks. The vertical red arrows show the predicted positions of the various particle species. Insert: Zoomed view of the MIP region of the same spectrum.}
  \label{fig:s3MassDistribution}
\end{figure}

\subsubsection{Particle identification}
\label{sec:hptpc_beam_flux:methods:s3:pid}

The UToF DAQ (see \citesec{sec:hptpc_beam_flux:overview:s3}) stores information about the size and time of signals observed by the SiPMs in \SThree.
As such, both timing and signal size cuts can be used to select protons and MIPs
This signal amplitude information is relevant due to the differing energy deposition of protons and MIPs at these momenta.

\citefig{fig:energyLoss} shows the mean energy loss for a variety of different materials as a function of $\beta \gamma$.
One can see that for all the materials, the minimum energy loss per unit distance occurs at $\beta\gamma \approx 3$ with a rapid rise at low values and a slower one at higher values.
For a charged pion with a momentum of \SI{0.8}{\giga\electronvolt\per\clight}, $\beta\gamma = 5.73$.
However, for a proton with the same momentum $\beta\gamma = 0.85$.
This leads protons to deposit more energy in the scintillator bars than the lighter MIPs.

\begin{figure}[h]
  \centering
  \includegraphics[width=.6\linewidth]{files/figures/hptpc_beam_flux/energyLoss}
  \caption[Mean energy loss for a variety of different materials.]{Mean energy loss for variety of different materials. Taken from~\cite{pdg2020}.}
  \label{fig:energyLoss}
\end{figure}

This greater energy deposition within the bars leads to an increased amount of scintillation light and so an increased signal size in the SiPMs.
Therefore, it is possible to use the SiPM signal size to discriminate between particle species.

\citefig{fig:tvsa} shows the relationship between $t_{\SThree} - t_{\SOne}$ and signal amplitude (here labelled as A1) for one of the bars in \SThree along with timing and signal cuts used to select particle types.
One can see that two populations are visible for all the different numbers of moderator blocks apart from \citefig{fig:tvsa:0} where three populations can be seen.
This third, slowest population is cause by deuterons.

The quicker population, produced by MIPs, does not appear to move with increasing numbers of moderator blocks.
This is because, even after moderation with 4 blocks, the particles are still in the minimum ionising regime.
However, the proton peak moves to higher amplitudes as the number of moderator blocks increases.
In this case, the protons already have $\beta\gamma < 3$ when the beam momentum is \SI{0.8}{\giga\electronvolt\per\clight}.
Looking at \citefig{fig:energyLoss} one can see that as $\beta\gamma$ falls further, as will occur when the protons are moderated, the energy loss and thus the amplitude rises.
Therefore, an amplitude cut can be used to select protons while reducing the number of background events.
Given that the gain of each SiPM array varies, the proton amplitude cut is determined by eye for each one individually.
The cut values vary in the range \SI{0.125}{\volt} to \SI{0.3}{\volt}.

\begin{figure}[t]
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/tvsa0}
    \end{adjustbox}
    \caption{0 blocks}
    \label{fig:tvsa:0}
  \end{subfigure}
  \hfill
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/tvsa1}      
    \end{adjustbox}
    \caption{1 block}
  \end{subfigure} \\
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/tvsa2}
    \end{adjustbox}
    \caption{2 blocks}
  \end{subfigure}
  \hfill
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/tvsa3}
    \end{adjustbox}
    \caption{3 blocks}
  \end{subfigure} \\

  \begin{subfigure}[t]{\textwidth}
    \begin{adjustbox}{max totalsize=.5\textwidth, center}
      \input{files/figures/hptpc_beam_flux/tvsa4}
    \end{adjustbox}
    \caption{4 blocks}
  \end{subfigure}

  \caption[Signal amplitude versus time of flight in \SThree]{Signal amplitude versus time of flight in \SThree for various numbers of moderator blocks. Also shown are the timing and signal amplitude cuts used to select protons (red) and MIPs (green) for this particular SiPM.}
  \label{fig:tvsa}
\end{figure}

Particles for which $\SI{35.75}{\nano\second} < t_{\SThree} - t_{\SOne} < \SI{37.75}{\nano\second}$ are identified as MIPs while those for which $\SI{53}{\nano\second} < t_{\SThree} - t_{\SOne} < \SI{115}{\nano\second}$ and which are above the amplitude threshold are identified as protons.
For the unmoderated sample, the upper bound of the timing cut is lowered to \SI{80}{\nano\second} in order to exclude deuterons.
The timing and amplitude cuts used for each sample for one SiPM are shown in \citefig{fig:tvsa}.

\subsubsection{Dead time correction}
\label{sec:hptpc_beam_flux:methods:s3:deadtime}

\citefig{fig:spillStructureComp} shows that significant differences are observed between the spill structure measured in \SThree and \SFour.
These differences do not originate from physical processes but rather the large, unknown dead time of the UToF DAq.
As \citefig{fig:spillStructureComp} shows, the UToF DAQ initially acquires hits at the start of the spill before failing to record much of the data from later in the spill.
The DToF DAQ, which has a negligible deadtime, continues to record a similar number of hits before declining gradually.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=.75\textwidth, center}
    \input{files/figures/hptpc_beam_flux/spillStructureComp}
  \end{adjustbox}
  \caption[Spill structure comparison in \SThree and \SFour]{Spill structure comparison in \SThree and \SFour for the unmoderated T10 beam.}
  \label{fig:spillStructureComp}
\end{figure}

In order to correct for this, it is necessary to identify a signal that is recorded by both DAQs that is linked to the number of particles per spill.
The $\SOne-\STwo$ coincidence signal fulfills this requirement.
In this case, hits registered in the UToF DAQ can be weighted such that the number of $\SOne-\STwo$ signals across the two DAQs match.
Because the UToF DAQ deadtime is clearly related to the time since the start of the spill, it is important to verify that the particle content of the spill does not change as a function of time within the spill.
\citefig{fig:proMipRatio} verifies that the ratio of protons to MIPs remains constant as a function of time across the spill.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=.75\textwidth, center}
    \input{files/figures/hptpc_beam_flux/protonMipRatioSpill}
  \end{adjustbox}
  \caption[Proton/MIP ratio as a function of time since spill start]{Proton/MIP ratio as a function of time since spill start for 2 moderator block data.}
  \label{fig:proMipRatio}
\end{figure}

The relationship between the number of $\SOne-\STwo$ hits in the two DAQs for various numbers of moderator blocks is shown in \citefig{fig:s1s2DeadtimeComp}.
Here the horizontal axis displays the number of $\SOne-\STwo$ signals recorded by the DToF DAQ for a given beam spill, $(\SOne\STwo)_{\text{DToF}}$.
Similarly, $(\SOne\STwo)_{\text{UToF}}$ is the number of $\SOne-\STwo$ signals recorded by the UToF DAQ in the same spill.
Each of these distributions has a polynomial of the form
\begin{equation}
  (\SOne\STwo)_{\text{UToF}}/(\SOne\STwo)_{\text{DToF}} = p0 \times (\SOne\STwo)_{\text{DToF}} + p1
\end{equation}
fitted where $p0$ and $p1$ are the parameters to be determined.

\begin{figure}[t]
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/s1s2Ratio0}
    \end{adjustbox}
    \caption{0 blocks}
  \end{subfigure}
  \hfill
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/s1s2Ratio1}      
    \end{adjustbox}
    \caption{1 block}
  \end{subfigure} \\
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/s1s2Ratio2}
    \end{adjustbox}
    \caption{2 blocks}
  \end{subfigure}
  \hfill
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/s1s2Ratio3}
    \end{adjustbox}
    \caption{3 blocks}
  \end{subfigure} \\
  \begin{subfigure}[t]{\textwidth}
    \begin{adjustbox}{max totalsize=.5\textwidth, center}
      \input{files/figures/hptpc_beam_flux/s1s2Ratio4}
    \end{adjustbox}
    \caption{4 blocks}
  \end{subfigure}
  
  \caption[Comparison of $\SOne-\STwo$ hits in the two ToF DAQs]{Comparison of $\SOne-\STwo$ hits in the two ToF DAQs. A first-order polynomial (red) fitted in each case.}
  \label{fig:s1s2DeadtimeComp}
\end{figure}

Having determined this relationship, \SThree events are weighted with weight, $w$.
This is based upon $(\SOne\STwo)_{\text{DToF}}$ in the spill and according to the relationship
\begin{equation}
  \frac{1}{w} = p0 \times (\SOne\STwo)_{\text{DToF}} + p1 \,.
\end{equation}
  
\subsection{\SFour specific methods}
\label{sec:hptpc_beam_flux:methods:s4}

\citefig{fig:s4Tof} shows the time of flight spectra for those particles detected in \STwo and \SFour.
For all of the samples apart from the four moderator block sample, two clear peaks are visible.
A quicker peak produced my MIPs is located at around \SI{42}{\nano\second} and does not move with increasing numbers of moderator blocks.
A second broader peak, produced by protons, is visible between \SI{65}{\nano\second} and \SI{100}{\nano\second}.
This second peak moves to slower times as more moderator blocks are added, before largely disappearing in the four moderator block configuration.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=.9\textwidth, center}
    \input{files/figures/hptpc_beam_flux/s4Tof}
  \end{adjustbox}
  \caption[Time of flight spectra measured in \SFour]{Time of flight spectra for the various moderator block configurations measured in \SFour. Here, the spectrum has been corrected for the bar efficiencies (see \citesec{sec:hptpc_beam_flux:methods:s4:efficiency}) and a flat background has been subtracted.}
  \label{fig:s4Tof}
\end{figure}

\citefig{fig:s4MassDistribution} shows the reconstructed mass distribution using the \STwo to \SFour time of flight.
This was produced using \citeeq{eq:massDistribution} with $p$ set to \SI{0.8}{\giga\electronvolt\per\clight}.
Here, one can see that the MIP peak matches well with the pion mass but the proton peak in data lies at a higher mass than the prediction.
This is due to protons losing energy in the walls of the HPgTPC pressure vessel which in turn, leads to this.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=.9\textwidth, center}
    \input{files/figures/hptpc_beam_flux/s4TofMass}
  \end{adjustbox}
  \caption[Reconstructed mass spectrum for \SFour]{Reconstructed mass spectrum for \SFour for the data taken without moderator blocks. The vertical arrows show the predicted positions of the various particle species.}
  \label{fig:s4MassDistribution}
\end{figure}

%%% Time of flight spectra and mass distribution
\subsubsection{Particle identification}
\label{sec:hptpc_beam_flux:methods:s4:pid}

Unlike \SThree, \SFour did not record the PMT signal sizes during the beam test.
Therefore, only timing information is used to distinguish between protons and MIPs.
Particles for which $\SI{36}{\nano\second} < t_{\SFour} - t_{\STwo} < \SI{51}{\nano\second}$ are identified as MIPs, while those for which $\SI{62}{\nano\second} < t_{\SFour} - t_{\STwo} < \SI{125}{\nano\second}$ are considered to be protons.

%%% Efficiency correction
\subsubsection{Efficiency correction}
\label{sec:hptpc_beam_flux:methods:s4:efficiency}

The light collection efficiency of the \SFour bars varies both between bars and as a function of position along the bar.
It is necessary to correct for these differences using a `standard candle', which in this case is the cosmic ray flux.
\SFour hits occurring outside of beam spills are taken to be cosmic in origin.
For each separate moderator block sample, the number of hits occurring outside of beam spills is measured as a function of bar number and position.
It is necessary to perform this process separately for each sample because of changes in the PMT voltages that may have occurred.

It is assumed that the flux of cosmic rays should be equivalent through each part of \SFour is equal.
Each \SFour bar is divided into \SI{7}{\centi\metre} segments and the bin values are scaled such that the bin with the greatest recorded number of hits has a value of 1.
This creates a map of the relative efficiency of the various \SFour bars.
These efficiency maps are shown in \citefig{fig:barEff}.
One can see that the bar efficiency is typically highest towards the middle of each bar (\SI{70}{\centi\metre}).
This is due to the requirement for coincident PMT signals to be observed in order for a hit to be recorded.
The fact that bars with higher efficiency are typically in the middle of \SFour is by construction; this is where the beam centre is and therefore where the best performing bars are placed.
Bar 10 was excluded from the analysis due its very low efficiency.

\begin{figure}[t]
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/barEff0}
    \end{adjustbox}
    \caption{0 blocks}
  \end{subfigure}
  \hfill
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/barEff1}      
    \end{adjustbox}
    \caption{1 block}
  \end{subfigure} \\
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/barEff2}
    \end{adjustbox}
    \caption{2 blocks}
  \end{subfigure}
  \hfill
  \begin{subfigure}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/barEff3}
    \end{adjustbox}
    \caption{3 blocks}
  \end{subfigure} \\

  \begin{subfigure}[t]{\textwidth}
    \begin{adjustbox}{max totalsize=.5\textwidth, center}
      \input{files/figures/hptpc_beam_flux/barEff4}
    \end{adjustbox}
    \caption{4 blocks}
  \end{subfigure}

  \caption[\SFour relative bar efficiencies]{\SFour relative bar efficiencies calculated using out-of-spill cosmic rays for each moderator block.}
  \label{fig:barEff}
\end{figure}

Beam events are weighted depending on the bar number and position where they are recorded with a weight which is the inverse of the efficiency for that particular bin.
Additionally, a further weight of \num{1.25} is applied to all events.
This weight represents the absolute efficiency of the bars and is derived from tests performed on \SFour bars with the $^{90}\text{Sr}$ source.
Using this source it was determined that the maximum measured rate of signals produced by the source was equal to \num{0.8} of the true rate.

\subsubsection{Background subtraction}
\label{sec:hptpc_beam_flux:methods:s4:bkg}

The other correction applied to the \SFour data consists of a background subtraction.
The background is determine by fitting a sum of signal and background functions to the time of flight spectra.
The signal functions are taken to be gaussians while the background is taken to be flat.
An example of a time of flight distribution with the combined signal and background function fitted is shown in \citefig{fig:bkgSub}.
These backgrounds are subtracted from the proton and MIP counts presented in \citesec{sec:hptpc_beam_flux:results:s4}.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=.8\textwidth, center}
    \input{files/figures/hptpc_beam_flux/bkgSubPaper}
  \end{adjustbox}
  \caption[Example of a time of flight distribution with signal and background functions fitted]{Example of a time of flight distribution measured in \SFour with signal and background functions fitted (red).}
  \label{fig:bkgSub}
\end{figure}

The background rates are shown in \citetab{tab:bkgRates}.
The rates initially increase as more moderator blocks are added.
For the 3 and 4 moderator block samples, the background rates fall however.
This follows the same pattern as the total number of beam particles measured in \SFour (see \citesec{sec:hptpc_beam_flux:results:s4}).

The ratio of signal protons to background events in the proton timing window falls as the number of moderator blocks increases.
This is due to increased scattering from the moderator blocks as more are added.
This scattering means that an increased number of particles strike \SFour without striking \STwo, a process that leads to false coincidences.
These false coincidences contribute to the background rate.

\begin{table}
  \caption[\SFour background rates for each moderator block sample]{\SFour background rates for each moderator block sample. The number of background events per spill in found by multiplying the numbers by the timing window in question.}
  \label{tab:bkgRates}
  \centering
  \begin{tabular}{c c}
    \hline
    \hline 
    Number of moderator blocks & Background events / spill / \si{\nano\second} \\
    \hline
    0 & \num{0.037(4)} \\
    1 & \num{0.066(5)} \\
    2 & \num{0.165(7)} \\
    3 & \num{0.124(9)} \\
    4 & \num{0.085(2)} \\
    \hline
  \end{tabular}
\end{table}

\section{Results}
\label{sec:hptpc_beam_flux:results}

Beam flux measurements made with the \SThree detector are detailed in \citesec{sec:hptpc_beam_flux:results:s3} while those made with the \SFour detector are detailed in \citesec{sec:hptpc_beam_flux:results:s3}.
A comparison of the data with simulation is shown in \citesec{sec:hptpc_beam_flux:results:MCData}.
The results presented here are all given in terms of the angles $\theta$ and $\phi$, defined in \citesec{sec:hptpc_beam_flux:overview:survey}.

\subsection{Flux measurements at \SThree}
\label{sec:hptpc_beam_flux:results:s3}

\citefig{fig:protonKeData} left, shows the kinetic energies of protons calculated using the \SOne to \SThree time of flight for varying numbers of moderator blocks.
One can clearly see that the energy range of protons is changed from \SIrange{210}{320}{\mega\electronvolt} for the unmoderated beam to \SIrange{60}{110}{\mega\electronvolt} when four moderator blocks are place in the beamline.

\citefig{fig:protonKeData} right, shows the subset of those protons that are determined to impinge upon the TPC by the angle at which they are travelling (see \citetab{tab:angDistS1} for the relevant angles for the TPC).
Here, one can see that the rate of low energy protons of protons (those with kinetic energies of less than \SI{80}{\mega\electronvolt}) impingin on the TPC is increased from negligible levels for the 0, 1, and 2 block samples to \num{9.7(1)} per spill for the 4 moderator block sample.
These protons will then lose further energy within the walls of the HPgTPC vessel, resulting in a flux of protons with less than \SI{50}{\mega\electronvolt} within the TPC.
This the desired energy regime where various neutrino interaction generators become discrepant (see \citefig{fig:generatorProtons}).

\begin{figure}[h]
  \begin{minipage}[t]{.5\linewidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/proKeS3}
    \end{adjustbox}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.5\linewidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/protonKeTpc}
    \end{adjustbox}
  \end{minipage}
  \caption[Proton kinetic energies measured in \SThree]{Left: Proton kinetic energies measured in \SThree for various numbers of moderator blocks. Right: Proton kinetic energies measured in \SThree for the subset of protons which are judged to have impinged on the TPC.}
  \label{fig:protonKeData}
\end{figure}

Additionally, \citefig{fig:protonKeData} right, shows that the the addition of moderator blocks also has a substantial effect on the multiplicity of protons impinging on the TPC.
One can see that adding moderator blocks initially increases the number of protons impinging on the TPC from \num{19.0(9)} per spill for the unmoderated beam to \num{108(3)} per spill for the three moderator block sample.
Adding the fourth moderator block removes the flux of protons with kinetic energies greater than \SI{100}{\mega\electronvolt} and reduces the number of protons striking the TPC to \num{21.4(2)} per spill.

\citefig{fig:protonMipS3} left, shows the number or protons detected in \SThree as a function of number of moderator blocks and off-axis angle $\theta$.
Similarly, \citefig{fig:protonMipS3} right, shows the same distribution but for protons.
For both of these distributions as more moderator blocks are added the peak value falls and the distribution broadens.
As a result, at off-axis angles the number of protons and MIPs increases as more moderator blocks are added.
One can tell by looking at \citetab{tab:angDistS1} that the TPC lies in this off-axis region.

\begin{figure}[h]
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/thetaS1mip}
    \end{adjustbox}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/thetaS1pro}
    \end{adjustbox}      
  \end{minipage}
  \caption[Proton and MIP distributions as a function of $\theta$]{Left: MIP rates as a function of $\theta$ as measured in \SThree. Right: Proton rates as a function of $\theta$ as measured in \SThree. The errors shown in the legends are statistical.}
  \label{fig:protonMipS3}
\end{figure}

As shown by comparing \citefig{fig:unmoderatedBeam} left, and \citefig{fig:s3Tof}, the steering of the beam leads to scattering within the steering magnets.
This scattering also leads to a broadening of the steered beam.
For the unmoderated and unsteered beam, the horizontal FWHM at \SThree is measured as \SI{9.6}{\centi\metre} while the vertical FWHM is measured as \SI{11.0}{\centi\metre}.
By comparison, the unmoderated and steered beam has a measured horizontal FWHM at \SThree of \SI{16.8}{\centi\metre}.

\citefig{fig:s3Ratios} left, shows the ratio $N_{\text{proton}}/N_{\text{MIP}}$ as a function of $\theta$ and the number of moderator blocks.
For all samples, the ratio rises from a low at the steered beam centre (\ang{1}) at more off-axis angles.
The ratio then peaks at values ranging from roughly \ang{-1} for the unmoderated beam to \ang{-2} for the 3 block sample, with the peak moving to lower angles as more moderator blocks are added.
For the 4 block sample, no clear peak is visible.
Overall, the addition of more moderator blocks reduces the proton/MIP ratio from a peak value of around 0.35 for the unmoderated beam to approximately 0.02 for the 4 block sample.
Thus one can see that the reducing the energy of protons incident on the TPC can at the price of reducing the beam purity.
A similar pattern is seen in \citefig{fig:s3Ratios} right with the peak gradually shifting to greater off-axis angles with increasing numbers of moderator blocks being added.

\begin{figure}[h]
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/thetaS1ratio}
    \end{adjustbox}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/phiS1ratio}
    \end{adjustbox}
  \end{minipage}
  \caption[Proton/MIP ratios as a function of off-axis angle and number of moderator blocks]{Left: Proton/MIP ratio as a function of $\theta$ and number of moderator blocks. Right: Proton/MIP ratio as a function of $\phi$ and number of moderator blocks. The TPC covers the horizontal angles \ang{-3.6} to \ang{-1.4} and vertical angles \ang{-2.6} to \ang{+2.6}.}
  \label{fig:s3Ratios}
\end{figure}

\subsection{Flux measurements at \SFour}
\label{sec:hptpc_beam_flux:results:s4}

\citefig{fig:s4Rates} shows the measured distribution of MIPs (left) and protons (right) in \SFour as a function of $\theta$ and the number of moderator blocks.
\citefig{fig:s4Rates} left, shows that the number of MIPs per spill peaks between \ang{-2} and \ang{-1} for all the various samples.
A similar pattern is observed for protons in \citefig{fig:s4Rates} right, where the peak occurs at approximately \ang{-2}.
The fall in the number of events between \ang{-1} and \ang{0} can be explained by beam particles impinging on the doors of the vessel.
Particles striking the doors travel through a greater length of steel (relative to those particles that strike the body of the vessel), resulting in greater energy losses and potentially stopping within the vessel.

\citefig{fig:s4Rates} left, shows that MIP multiplicity changes significantly with the addition of moderator blocks from \num{236(4)} per spill for the unmoderated beam to \num{1132(9)} for 3 block configuration.
The rate then falls with the addition of a fourth moderator block.
This pattern can be explained by an increase in scattering caused by the blocks leading to more particles passing through \STwo and \SFour which are both located in off-axis positions.
The fall in MIPs due to the addition of the fourth moderator block can be explained as lower energy particles being attenuated in the walls of the HPgTPC pressure vessel.

A similar pattern is observed for protons in \citefig{fig:s4Rates} right.
However, in this case the number of observed protons begins to fall with the addition of the second moderator block.
This is due to the larger energy loss by the protons within the moderator.
This additional energy loss leads to the attenuation of a larger proportion of the protons within the vessel walls, resulting in the observation of fewer events in \SFour.

\begin{figure}[h]
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/thetaS4Mip}
    \end{adjustbox}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/thetaS4pro}
    \end{adjustbox}
  \end{minipage}
  \caption[\SFour particle rates as a function of $\theta$ and moderator blocks]{Left: Measured distributions of MIPs in \SFour as a function of of $\theta$ and the number of moderator blocks. Right: Measured distributions of protons in \SFour as a function of $\theta$ and the number of moderator blocks.}
  \label{fig:s4Rates}
\end{figure}

\citefig{fig:s4Ratios} shows the proton/MIP ratio as a function of the two off-axis angles.
For all of the various moderator block configurations, the ratio is flat across $\theta$ and $\phi$.
The ratio falls as more moderator blocks are added, from a high of 0.5 for the unmoderated beam to \num{0.002} for the 4 moderator block data.
This very low ratio for the 4 block data is thought to be due to attenuation of protons within the pressure vessel.

\begin{figure}[h]
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/thetaS4ratio.tex}
    \end{adjustbox}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/phiS4ratio.tex}
    \end{adjustbox}
  \end{minipage}
  \caption[Proton/MIP ratios as measured in \SFour as a function of $\theta$ and $\phi$]{Proton/MIP ratios as measured in \SFour as a function of $\theta$ and $\phi$}
  \label{fig:s4Ratios}
\end{figure}

\subsection{Comparisons with simulation}
\label{sec:hptpc_beam_flux:results:MCData}

\citefig{fig:protonKeData} right, provides a measurement of the number of protons incident upon the TPC.
However, in order to gain an estimate of the number and energy of protons traversing the TPC, a Monte Carlo (MC) simulation is performed using GEANT4~\cite{geant}.
The simulation contains geometric volumes representing the pressure vessel, the TPC and \SFour.
Protons are propagated through this geometry, with their starting positions and momenta taken from \SThree data (see \citefig{fig:protonKeData}).
This step ensures that the input distributions match the true beam conditions as closely as possible.

The simulation is validated in multiple ways.
The simulated and measured time of flight spectra are compared.
Additionally, the ratio of protons detected in \SThree and \SFour is compared in data and MC.
The systematic uncertainties on the latter measurement are discussed in \citesec{sec:hptpc_beam_flux:results:MCData:systs}, while the validation is discussed in \citesec{sec:hptpc_beam_flux:results:MCData:validation}.
The results of the simulation are discussed in \citesec{sec:hptpc_beam_flux:results:MCData:results}

\subsubsection{Systematic uncertainties}
\label{sec:hptpc_beam_flux:results:MCData:systs}

Systematic uncertainties on the number of protons measured in \SThree and \SFour are estimated for both simulation and data.
These uncertainties are tabulated in \citetab{tab:systs}.

The systematic uncertainty on the number of simulated protons reaching \SFour, $n_{\SFour,~\text{MC}}$, is evaluated by varying the initial geometric conditions of the simulation and observing the fractional change in $n_{\SFour,~\text{MC}}$.
Additionally, the simulation is rerun with an additional \SI{1}{\centi\metre} thick piece of acrylic in the beamline and the change in $n_{\SFour,~\text{MC}}$ observed.
We allow this systematic to act as a proxy for the uncertainty on the prescence of unknown light materials in the beamline.

\begin{table}
  \caption[Systematic errors on the number of protons at \SThree and \SFour for data and Monte Carlo]{Systematic errors on the number of protons at \SThree and \SFour for data and Monte Carlo. All values are the percent error of the \SFour proton count with the exception of the uncertainty on the efficiency of \SThree which is the percent error on the proton count measured in \SThree. All of these uncertainties are treated as uncorrelated.}
  \label{tab:systs}
  \begin{tabular}{c c c c c c}
    \hline
    \hline
    \multicolumn{6}{c}{\textbf{Monte Carlo}} \\
    \hline
    & \multicolumn{5}{c}{Number of moderator blocks} \\
    & 0 & 1 & 2 & 3 & 4 \\
    \hline
    Systematic uncertainty on $n_{\mathit{S4},~\text{MC}}$ & 9.5\% & 8.0\% & 8.5\% & 17.0\% & 8.0\% \\
    \hline
    \multicolumn{6}{c}{\textbf{Data}} \\
    \hline
    & \multicolumn{5}{c}{Number of moderator blocks} \\
    Source of systematic error & 0 & 1 & 2 & 3 & 4 \\
    \hline
    Absolute efficiency of $\mathit{S3}$ & 1.1\% & 11.4\% & 7.0\% & 11.4\% & 4.9\% \\
    Absolute efficiency of $\mathit{S4}$ & 11.0\% & 11.0\% & 11.0\% & 11.0\% & 11.0\% \\ 
    $\mathit{S4}$ angular correction & 2.9\% & 1.5\% & 6.7\% & 8.2\% & 4.1\% \\
    $\mathit{S4}$ background uncertainty & 0.18\% & 0.16\% & 1.1\% & 1.4\% & 8.1\% \\
    \hline
    \textbf{Total} & 11.5\% & 16.0\% & 14.7\% & 18.3\% & 18.9\% \\
    \hline
  \end{tabular}
\end{table}

For data, the error on the absolute efficiency of \SThree is evaluated by taking the $\pm 1 \sigma$ uncertainty on the fitted relationship between $(\SOne\STwo)_{\text{UToF}}/(\SOne\STwo)_{\text{DToF}}$ and $(\SOne\STwo)_{\text{DToF}}$ (see \citesec{sec:hptpc_beam_flux:methods:s3:deadtime}) and evaluating the fractional change in the number of protons detected by \SThree.

The error on the absolute efficiency of \SFour is evaluated from the calibration tests performed on the bars with a $^{90}\text{Sr}$ source (see \citesec{sec:hptpc_dtof_characterisation:characterisation:barRes}).
From these tests an absolute efficiency of 0.8 was determined.
However, the readout used in these tests is significantly different to that used in the beam test and therefore there is a significant uncertainty attached to this number.
This uncertainty was evaluated by taking the standard deviation in the absolute efficiency measured using the $^{90}\text{Sr}$ source.

The uncertainty on the \SFour relative efficiency correction (see \citesec{sec:hptpc_beam_flux:methods:s4:efficiency}) is evaluated by altering the number of horizontal bins used to correct each bar from 20 to 10 and calculating the resulting change in the number of detected \SFour protons.

Finally, the uncertainty on the \SFour background subtraction (see \citesec{sec:hptpc_beam_flux:methods:s4:bkg}) is calculated by varying the flat background within the $\pm 1 \sigma$ fit errors and determining the resulting fractional change in the number of \SFour protons.
One can see that this uncertainty has the greatest effect in the 4 moderator block case.
This is due to the the very small number of protons detected relative to the background.

\subsubsection{Validation of simulation}
\label{sec:hptpc_beam_flux:results:MCData:validation}

The simulation is validated against data by comparing the number of protons reaching \SThree and \SFour for both.
The kinetic energy spectrum of simulated protons judged to have been detected in \SFour is shown in \citefig{fig:protonS4Sim}.
Protons are judged to have been detected in \SFour if they pass through the relevant geometry volume within the timing windows from \citesec{sec:hptpc_beam_flux:methods:s4:pid} and have a kinetic energy of more than \SI{10}{\mega\electronvolt} (momentum of \SI{140}{\mega\electronvolt\per\clight}).
For all samples a significant reduction in kinetic energy is observed from the nominal beam energy due to energy loss within the walls of the pressure vessel.
In particular, for the 4 block sample, very few particles survive through the second vessel wall.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=.7\textwidth, center}
    \input{files/figures/hptpc_beam_flux/proKeS4Mc}
  \end{adjustbox}
  \caption[Kinetic energy distributions for simulated protons reaching \SFour.]{Kinetic energy distributions for simulated protons reaching \SFour. A detection threshold of \SI{10}{\mega\electronvolt} is applied. }
  \label{fig:protonS4Sim}
\end{figure}

\citefig{fig:tofS4Sim} shows a comparison of the simulated and measured time of flight between \STwo and \SFour for protons for varying number of moderator blocks.
For all moderator block samples the peak positions in data an simulation agree to within \SI{2}{\nano\second}.
This confirms that the energy loss in the pressure vessel is consistent between data and simulation.

\begin{figure}[h]
  \begin{adjustbox}{max totalsize=.7\textwidth, center}
    \input{files/figures/hptpc_beam_flux/tofS4Sim}
  \end{adjustbox}
  \caption[Comparison of simulated and measure proton time of flight from \STwo to \SFour]{Comparison of simulated and measure proton time of flight from \STwo to \SFour. The data are shown as points while the simulation results are shown as solid lines. All distributions are area normalised to 1.}
  \label{fig:tofS4Sim}
\end{figure}

\citetab{tab:s3s4Ratios} shows the number of protons reaching \SFour divided by the number of protons reaching \SThree for both data and MC, for each moderator block sample.
In each case, the systematic errors detailed in \citesec{sec:hptpc_beam_flux:results:MCData:systs} are combined with the statistical errors to give the error shown.
One can see that there is some agreement between the data and MC which indicates both that the corrections detailed in \citesec{sec:hptpc_beam_flux:methods} are well-motivated and that the simulation represents the data well.

\begin{table}
  \centering
  \caption[Comparison of number of protons reaching \SThree and \SFour in data and Monte Carlo]{Ratio of protons reaching \SFour to the number of protons reaching \SThree in data and Monte Carlo. Here, the errors are combined statistical and sytematic.}
  \begin{tabular}{c|c c c}
    \hline
    \hline
    Number of moderator blocks & Monte Carlo & Data & Data/MC\\
    \hline
    $0$ & $0.027 \pm 0.003$ & $0.049 \pm 0.007$ & $1.8 \pm 0.3$ \\
    $1$ & $0.067 \pm 0.005$ & $0.09 \pm 0.01$ & $1.3 \pm 0.2$ \\
    $2$ & $0.084 \pm 0.007$ & $0.10 \pm 0.01$ & $1.2 \pm 0.2$ \\
    $3$ & $0.06 \pm 0.01$ & $0.036 \pm 0.007$ & $0.7 \pm 0.2$ \\
    $4$ & $0.011 \pm 0.001$ & $0.008 \pm 0.001$ & $0.7 \pm 0.1$ \\
    \hline
  \end{tabular}
  \label{tab:s3s4Ratios}
\end{table}

\subsubsection{Simulation results}
\label{sec:hptpc_beam_flux:results:MCData:results}

\citefig{fig:protonTpcSim} shows the momenta and kinetic energies of those simulated protons that enter the TPC active volume.
These plots show that the use of 4 moderator blocks is well motivated, given that for this sample, the flux of protons entering the TPC active volume is almost entirely within the region of interest (proton kinetic energy of less than \SI{50}{\mega\electronvolt}).
In fact, \num{4.9(1)} protons per spill with energies below \SI{50}{\mega\electronvolt} entered the TPC active volume in the 4 moderator block case
The 3 moderator block sample also had a significant proton flux within this energy range.
However, the total number of protons entering the TPC active volume for the 3 moderator block sample (\num{62(2)} per spill) is significantly more than for the 4 block sample (\num{7.0(1)} per spill).
Given that part of the motivation for modifying the beam is to reduce the multiplicity of particles entering the TPC, this again provides justification for the choice of 4 moderator blocks.

\begin{figure}[h]
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/momTpcSim}
    \end{adjustbox}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.5\textwidth}
    \begin{adjustbox}{max totalsize=\textwidth, center}
      \input{files/figures/hptpc_beam_flux/keTpcSim}
    \end{adjustbox}    
  \end{minipage}
  \caption[Momentum and kinetic energy distributions of simulated protons reaching the active volume of the TPC]{Left: Momentum distributions of simulated protons reaching the active volume of the TPC. Right: Kinetic energy distributions of simulated protons reaching the active volume of the TPC. The errors shown in the legend are the statistical errors.}
  \label{fig:protonTpcSim}
\end{figure}

