\chapter{Calibration of the ProtoDUNE detector}
\label{sec:pdune_calibration}

\section{Electron lifetime measurements}
\label{sec:pdune_calibration:lifetime}

In this chapter electron lifetime measurements from two sources are presented.
The first of these measurements comes from the purity monitors situated within the ProtoDUNE-SP cryostat (see \citesec{sec:protodune:prms}).

The second of these measurements utilises the high rate of cosmic rays impinging upon the detector.
These cosmic rays have a well known and roughly constant energy deposition before they stop.
This constant energy deposition means that they can be used as a `standard candle' throughout the TPC.
As a result, any observed changes in the energy deposition as a function of position within the detector must result from detector non-uniformities.
In particular, measured changes in the charge deposition as a function of drift distance can be used to measure the electron lifetime.

This charge deposition per unit length is commonly termed \dqdx.
Typically, this \dqdx is measured in detector units of ADC/cm where ADC is measure of the signal amplitude measured on a wire.
In order to convert this into an energy deposition per unit length, \dedx, further conversion factors are required.
However, merely comparing \dqdx is sufficient to calculate electron lifetimes.

This measurement is attempted and presented in this section.

\subsection{Coordinate system}
\label{sec:pdune_calibration:lifetime:coords}

Positions within the ProtoDUNE-SP detector are defined by a right-hand coordinate system.
Under this coordinate system, the $Y$ axis points vertically upward, the $X$ axis runs parallel to the electron drift direction and the $Z$ axis is horizontal, pointing roughly in the direction of the beam.
In this coordinate system, the origin lies at the bottom of the central cathode at the TPC face where the beam enters.
This means that the TPC active volume is defined approximately by $\SI{-360}{\cm} < X < \SI{360}{\cm}$, $\SI{0}{\cm} < Y < \SI{610}{\cm}$ and $\SI{0}{\cm} < Z < \SI{700}{\cm}$.

\subsection{Particle selection}
\label{sec:pdune_calibration:lifetime:selection}

In order to make an accurate measurement of the electron lifetime, it is important to ensure that those particles which are selected have the desired constant energy profile.
Typically, particles generate one of two types of structure in a LAr TPC.

High energy electrons and photons typically generate structures termed `showers' when they strike a high density material such as liquid argon.
In the case of electrons, these showers develop due to the emission of photons by the electron from bremsstrahlung.
These photons then produce further $e^{+}e^{-}$ pairs of lower energy via pair production and the process continues until the energy of the remaining photons falls below the threshold required for pair production.
A similar process occurs for photons but without the initial bremsstrahlung phase.
An image of a typical electromagnetic shower in a LAr TPC is shown in \citefigL{fig:trackShower}.
One can see that the energy deposition occurs in a rough cone shape with many branches.

Heavier particles such as proton, muons and hadrons typically produce `tracks' rather than showers.
This is due to their larger mass which inhibits radiative energy losses such as bremsstrahlung.
Instead they typically produce linear energy depositions until either scattering or coming to rest.
A typical image of a track recorded in ProtoDUNE-SP is shown in \citefigR{fig:trackShower}.
These tracks have an energy deposition that is more easily measured than that of showers.

\begin{figure}[h]
	\begin{minipage}[t]{.49\linewidth}
		\includegraphics[width=\linewidth]{files/figures/protodune_calibration/showerCand}
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.49\linewidth}
		\includegraphics[width=\linewidth]{files/figures/protodune_calibration/trackCand}		
	\end{minipage}
	\caption[Images of typical track and shower structures in ProtoDUNE-SP]{Left: Image of a \SI{0.5}{\GeV\per\clight} electron candidate in ProtoDUNE-SP, showing typical shower structure, from~\cite{protodunePerformance}. Right: Image of a \SI{1}{\GeV\per\clight} stopping proton candidate in ProtoDUNE-SP, showing typical track structure, from~\cite{protodunePerformance}.}
	\label{fig:trackShower}
\end{figure}

As shown in \citefig{fig:energyLoss}, as charged particles reach lower momenta their energy loss grows.
Therefore, it is desirable to only select those particles that are not in this region of rapidly changing energy deposition.
Specifically, it is desirable to only select those particles in the minimum ionising region of the energy loss profile.

\citefigL{fig:muonEDep}, shows the relationship between a muon's residual range and its average \dedx in liquid argon.
The average energy loss is calculated here using the `Bethe' formula~\cite{pdg2018} which gives the energy energy loss for a particle of charge $z$, mass $M$ and with a velocity $v$ such that $\beta = \frac{v}{c}$ and $\gamma = 1 / \sqrt{1 - \beta^{2}}$:
\begin{equation}
	\left< -\frac{dE}{dx} \right> = K z^{2} \rho \frac{Z}{A} \frac{1}{\beta^{2}} 
	\left[ \frac{1}{2} \ln \frac{2m_{e}c^{2} \beta^{2} \gamma^{2} W_{\text{max}}}{I^{2}} - \beta^{2} - \frac{\delta (\beta \gamma)}{2} \right] \, .
\end{equation}
Here, $Z$, $A$, $\rho$ and $I$ are the atomic number, relative atomic mass, density and mean excitation energy of the target medium.
$m_{e}$ is the electron rest mass and $K$ is equal to \SI{0.307075}{\MeV\per\mole\square\cm}.
The term $\delta(\beta\gamma)$ is known as the density-effect correction and is computed using a parametrisation from~\cite{densityEffect}.
$W_{\text{max}}$ is the maximum energy transferred to an electron in a single collision and is equal to 
\begin{equation}
	W_{\text{max}} =  \frac{ 2 m_{e} c^{2} \beta^{2} \gamma^{2} }{ 1 + 2\gamma m_{e}/M + (m_{e}/M)^{2} } \, .
\end{equation}
One can see that, at residual range of $>\SI{50}{\cm}$ there is little change in the energy loss with increasing range.

\citefigR{fig:muonEDep} shows the variation in the calculated most probable value (MPV) of energy loss for a muon in liquid argon as a function of muon kinetic energy.
Here one can see, that even at energies of up to \SI{100}{\GeV} the muon energy loss remains roughly constant compared to the minimum.
The most probable energy loss is calculated using the formula~\cite{mpvELoss}
\begin{equation}
	\Delta_{p} = \xi \left[ \ln \frac{2m_{e}c^{2} \beta^{2} \gamma^{2}}{I^{2}} +
	\ln \frac{\xi}{I} + j - \beta^{2} - \delta(\beta\gamma) \right] \, ,
\end{equation}
where 
\begin{equation}
	\xi = \left( \frac{K}{2} \right) \left< \frac{Z}{A} \right> z^{2} \left( \frac{x\rho}{\beta^{2}} \right)~\text{MeV}
\end{equation}
and $x$ is the thickness of the material (here \SI{0.65}{\cm} is chosen).

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/dEdxRange}
		\end{adjustbox}
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/dEdxKineticEnergy}
		\end{adjustbox}
	\end{minipage}
	\caption[Muon energy deposition as a function of range and kinetic energy]{Left: Calculated average muon energy loss in liquid argon as a function of residual range. Right: Calculated most probable energy loss in liquid argon as a function of muon kinetic energy.}
	\label{fig:muonEDep}
\end{figure}

\citefig{fig:keVsRange} shows the relationship between muon residual range and kinetic energy in liquid argon. 
Here the residual range is calculated under the continuous slowing down approximation (CSDA).
Under this approximation it is assumed that the energy loss at each point of a particle's track is equal to the stopping power with no fluctuations~\cite{protonRangeTables}.
This is used to translate between range and kinetic energy and produce \citefigL{fig:muonEDep}.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.5\linewidth, center}
		\input{files/figures/protodune_calibration/resRangeKE}
	\end{adjustbox}
	\caption[Muon range in liquid argon as a function of kinetic energy]{Muon range in liquid argon under the continuous slowing down approximation (CSDA) as a function of kinetic energy. The red points are taken from~\cite{muonCSDA}. The black line is a cubic spline drawn through the points.}
	\label{fig:keVsRange}
\end{figure}

%% Track selection
From \citefig{fig:muonEDep} left and right, one can see that, aside from the last 40 or \SI{50}{\cm} of the track, muons will have uniform energy deposition in liquid argon.
Therefore, any track selection used for detector calibration should avoid using the ends of muon tracks.
However, excluding the last \SI{50}{\cm} of all muon tracks regardless of if they stop in the detector or not would result in a significant volume of the detector which could not be effectively calibrated by this method.
Therefore, it is decided to instead select all those cosmic ray tracks which exit the detector and assume that they are not close to stopping.
Specifically, those tracks that cross the cathode and at least one of the anodes are selected.

Cathode-anode crossers are selected using cuts on the track start and end points. 
A track is considered to cross the cathode and an anode if one track end point is reconstructed with $X > \SI{340}{\cm}$ and the other is reconstructed with $X < \SI{0}{\cm}$.
Alternatively, if a track has one end point reconstructed with $X > \SI{0}{\cm}$ and the other end point is reconstructed with $X < \SI{-340}{\cm}$ it is considered to cross the cathode and the anode.

Requiring that tracks cross the cathode and an anode has two outcomes.
Firstly, it ensures that all the selected tracks have lengths equal to at least the drift distance and excludes short tracks that may be more easily mis-reconstructed.

Secondly, it allows the tracks to be given a definite time at which they entered the TPC.
As mentioned in \citesec{sec:dune:fd:lartpc}, TPCs such as ProtoDUNE-SP produce multiple 2-dimensional images which can be combined via reconstruction algorithms~\cite{pandora} to form 3-dimensional reconstructed tracks.
Typically, for neutrino induced events in LAr TPCs a definite drift coordinate can be reconstructed using timing information from the neutrino beam.

However for external particles such as cosmic rays, which are impinging on the detector continuously, this beam timing information is obviously not available.
Instead, reconstruction techniques must be utilised.

Specifically, the Pandora software package~\cite{pandora} looks at tracks in the two TPCs, separated by the central cathode.
If two 3-dimensional clusters in neighbouring drift volumes have similar direction vectors and an equal and opposite shift in the drift direction from the cathode, they can be stitched across the cathode to form one larger track.
This track will therefore have a definite time at which it crossed the cathode, often termed a $t_{0}$.
In turn, this allows definite drift coordinates and times to be reconstructed for all points in the track via the equation
\begin{equation}
	t_{\text{drift}} = t_{\text{hit}} - t_{0} \, ,
\end{equation}
where $t_{\text{hit}}$ is the recorded hit time in the TPC.

Cosmic rays are identified by the Pandora reconstruction chain. 
This reconstruction chain focusses on reconstructing track-like particle and has been shown to work well in the MicroBooNE experiment~\cite{pandoraUboone}. 
Tracks satisfying one of three conditions are considered to be produced by cosmic rays.
Firstly, those tracks starting at the top of the detector and ending at the bottom are considered to be cosmic rays.
Secondly, those tracks with a reconstructed $t_{0}$ which is inconsistent with the beam time are also considered to be cosmic rays.
Finally, any tracks which have reconstructed hits which appear to be outside the detector when assuming $t_0 = 0$ are considered to be inconsistent with beam particles and are thus cosmic rays.

%% Angular cuts explanation
Constraints are also placed on the angle of tracks used in the selection.
These constraints are in place due to difficulties in reconstructing the track \dqdx at certain angles.
This issue is shown in \citefigR{fig:dqdxAng}, which shows the average track \dqdx as a function of two angles, \thetai{XZ} and \thetai{YZ}.

These track angles are described respectively by the formulae
\begin{align}
	\thetai{XZ}	&= \arctan \left( \frac{\boldsymbol{X}}{\boldsymbol{Z}} \right) \\
	\thetai{YZ} &= \arctan \left( \frac{\boldsymbol{Y}}{\boldsymbol{Z}} \right) \, ,
\end{align}	
where $\boldsymbol{X}$, $\boldsymbol{Y}$ and $\boldsymbol{Z}$ are the direction vectors of the track.

One can see that at certain values of \thetai{XZ} (around $\pm\ang{90}$) and \thetai{yz} (around \ang{-90}) the average track \dqdx falls significantly.
The difference around $\thetai{XZ} = \pm \ang{90}$ is caused by tracks travelling close to parallel with the drift direction while the difference at $\thetai{YZ} = \ang{-90}$ is due to tracks travelling vertically downwards.
However, \citefigL{fig:dqdxAng} shows that this does have the effect of cutting out a large number of the tracks.

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/h2Angle}
		\end{adjustbox}
	\end{minipage}
	\begin{minipage}[t]{.5\linewidth}		
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/h2dqdxAngle}
		\end{adjustbox}
	\end{minipage}
	\caption[Number of tracks and average track \dqdx as a function of track angle for exiting cosmic rays.]{Left: Number of exiting cosmic ray tracks with a $t_{0}$ tag as a function of track angle. Right: Average track \dqdx as a function of track angle for reconstructed exiting cosmic rays. Both plots show data from a single run. Also shown are dotted lines indicating the angular cuts used in the analysis.}
	\label{fig:dqdxAng}
\end{figure}

In both cases, the track \dqdx is not well reconstructed due to fundamental limitations of the detector. 
Particles travelling directly toward the readout planes will produce charge deposits that will then drift either onto the same wire or wires very close by, making reconstruction difficult.
Similarly, cosmic rays travelling vertically downwards are travelling parallel to the wires of the collection plane which leads to the same issue of many charge deposits being read out on the same collection plane wire.
Since this is the plane used to perform calorimetry in this analysis, this causes issues with the reconstruction.

\subsection{Measurement process}

Having selected the cathode-anode crossing tracks as detailed in \citesec{sec:pdune_calibration:lifetime:selection} a two-dimensional histogram is created.
The 2 axes of the histogram are the corrected drift time, $t_{\text{drift}}$ and the \dqdx value for that particular track hit as measured on the collection plane. 
For each of the selected cathode-anode crossers, every track hit is added to the histogram.
A distribution such as the one shown in \citefig{fig:dqdxDrift} is formed.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.7\linewidth, center}
		\input{files/figures/protodune_calibration/h2dqdxDrift}
	\end{adjustbox}
	\caption[Hit drift time vs. measured \dqdx for cathode-anode crossers in ProtoDUNE-SP]{Two-dimensional histogram showing hit \dqdx against measured hit drift time for track hits deriving from cathode-anode crossing cosmic rays in ProtoDUNE-SP. The data come from one run.}
	\label{fig:dqdxDrift}
\end{figure}

One can see in \citefig{fig:dqdxDrift} that the peak value of \dqdx (the darkest point in each row) shifts as the drift distance changes.
This is thought to be due to the effects of electron lifetime.
One can also observe that there are few hits at near the maximum and minimum drift times.

This movement of the peak position is clearer in \citefig{fig:dqdx1d}, which shows two different rows from \citefig{fig:dqdxDrift} as 1-dimensional histograms.
Each of these histograms has been area normalised to 1.
A Landau distribution convolved with a Gaussian~\cite{langaus} has been fitted to each set of data points and is shown as a solid line in each case.
In both cases this function appears to match the data well.
The most probable value (MPV) for the distribution moves from a value of \SI{279.8(2)}{\ADC\per\cm} for $t_{\text{drift}} = \SI{0.35(5)}{\ms}$ to a value of \SI{220.5(1)}{\ADC\per\cm} for $t_{\text{drift}} = \SI{2.45(5)}{\ms}$.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.8\linewidth, center}
		\input{files/figures/protodune_calibration/dqdx1d}
	\end{adjustbox}
	\caption[\dqdx distributions for two different drift times in ProtoDUNE-SP]{\dqdx distributions for two different drift times in ProtoDUNE-SP data. The solid lines show the result of fitting a Landau distribution convolved with a Gaussian to each set of points. Both sets of points are area normalised to 1.}
	\label{fig:dqdx1d}
\end{figure}

This process is repeated for each of the \SI{0.1}{\ms} $t_{\text{drift}}$ bins.
The measured peak is then plotted against the drift time.
An function of the form 
\begin{equation}
	(dQ/dx)_{\text{MPV}} = A \exp^{-t_{\text{drift}}/\tau}
	\label{eq:lifetimeFromdqdx}
\end{equation}
where $A$ and $\tau$ are free parameters and $\tau$ is the measured electron lifetime.

\citefig{fig:mgPeakDriftMcNoSCE} shows the resulting distributions of $(dQ/dx)_{\text{MPV}}$ against $t_{\text{drift}}$ as a function of height in the detector.
Additionally, a function of the same form as \citeeq{eq:lifetimeFromdqdx} is fitted to each set of points representing a particular height in the detector.
One can see that fit range used is $\SI{1}{\ms} < t_{\text{drift}} < \SI{2.5}{\ms}$ since at the extracted lifetime appears to behave as expected.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.6\linewidth, center}
		\input{files/figures/protodune_calibration/mgPeakDriftMcNoSCE}
	\end{adjustbox}
	\caption[Peak \dqdx value at a range of different heights in the detector as a function of $t_{\text{drift}}$ in simulation]{Peak \dqdx value at a range of different heights in the detector as a function of $t_{\text{drift}}$ for ProtoDUNE-SP simulation.}
	\label{fig:mgPeakDriftMcNoSCE}
\end{figure}

\citefig{fig:lifetimeNoSCE} shows the measured lifetime as a function of height within the detector for ProtoDUNE-SP simulation. 
The simulated electron lifetime (\SI{35}{\ms}) is shown as a red dashed line.
One can see that, at many heights, the measured lifetime is consistent with simulation but there are small deviations at some points.
The greatest difference between two points is about \SI{5}{\ms}.
For a \SI{2.5}{\ms} drift time, this equates to a difference in the measured charge of 1\%.
Overall, this validates the method used.

\begin{figure}[h] 
	\begin{adjustbox}{max totalsize=.6\linewidth, center}
		\input{files/figures/protodune_calibration/mcNoSCELifetimeHeight}
	\end{adjustbox}
	\caption[Measured electron lifetime as a function of height within the detector in simulation]{Measured electron lifetime from cosmic ray tracks as a function of height in the detector for simulation. The simulated lifetime (\SI{35}{\ms}) is shown as the red dotted line.}
	\label{fig:lifetimeNoSCE}
\end{figure}

\subsection{Space charge effects}
\label{sec:pdune_calibration:lifetime:sce}

Previously, it has often been stated that TPCs operate by drifting ionisation electrons across a gap between two charged surfaces.
However, no mention has been made of the corresponding ions produced by the same charged particles when traversing the detector medium.

These positively charged ions will experience the same drift field as the ionisation electrons but will instead drift towards the cathode (rather than the anode).
For a detector medium such as liquid argon, the $\text{Ar}_{2}^{+}$ ions are approximately \num{140000} times heavier than the corresponding electrons and thus will drift much more slowly.
In fact, the ICARUS T600 collaboration reports an argon mobility of \SI{0.9d-3}{\cm\squared\per\volt\per\second}~\cite{icarusSpaceCharge} compared with an electron mobility of around \SI{470}{\cm\squared\per\volt\per\second}~\cite{electronMobility} for electrons.
This slow drifting can lead to a build up of positive ions within the detector and distortions in the applied electric field. 
An analysis of these effects is given in Ref.~\cite{spaceCharge2021}.

ProtoDUNE-SP is vulnerable to space charge effects due to its position on the Earth's surface.
This means that a high constant flux of cosmic rays constantly strikes the detector, producing a steady supply of positive ions which build up and cause distortions from the nominal electric field.
These distortions affect the calorimetric reconstruction in multiple ways.
Firstly, distortions in the electric field result in changes to the drift velocity of ionisation electrons which must be accounted for in order to correctly calculate track segment lengths when measuring \dqdx.
Secondly, as shown in \citefig{fig:recombFactors} the applied electric field in a TPC affects the number of ionisation electrons which recombine. 
Therefore, any change in the electric field will alter the amount of charge liberated by a charged particle which is then free to drift to the readout planes.

In order to correct for these effects, maps of the effective electric field (including contributions from space charge) and spatial distortions are constructed.
These distortions are evaluated by taking exiting tracks and measuring the offsets between the reconstructed end points and the TPC faces
These are used to generate a data-driven simulation of the space charge effects which can then be inverted to provide corrections for said effects~\cite{protodunePerformance}.
Two-dimensional slices of the three-dimensional electric field distortion map for ProtoDUNE-SP data are shown in \citefig{fig:eFieldDistortion}. 
Here, one can see that the magnitude of the electric field is changed at some points by as much as 25\%.

\begin{figure}[h]
	\centering
	\includegraphics[width=.9\linewidth]{files/figures/protodune_calibration/eFieldDistortion}
	\caption[Two-dimensional slices of the three-dimensional electric field distortion map in ProtoDUNE-SP data]{Two-dimensional slices of the three-dimensional electric field distortion map in ProtoDUNE-SP data, from~\cite{protodunePerformance}. Left: A slice taken at constant $Z$. Right: A slice taken at constant $Y$.}
	\label{fig:eFieldDistortion}
\end{figure}

\subsection{Results from data}
\label{sec:pdune_calibration:lifetime:data}

The process detailed above is repeated for multiple data runs.
In each case the calorimetry is corrected for space charge effects (SCE). 
This effect and its corrections are detailed in \citesec{sec:pdune_calibration:lifetime:sce}.
A variety of runs with different lifetimes (as measured by the purity monitors) are analysed.

Graphs of the measured \dqdx peak positions against drift time are shown for each of the analysed runs in \citefig{fig:dqdxPeak1} and \citefig{fig:dqdxPeak2}.
In both cases function of the form shown in \citeeq{eq:lifetimeFromdqdx} is fitted to the data points. 
One can observe that the fit range is between \tdrift values of \SI{0.2}{\ms} and \SI{1.5}{\ms}.
The choice is made to exclude lower values of \tdrift due to the low statistics in this region.

%% Figures subject to change if I end up changing the analysis procedure
\begin{figure}[h]
	\centering
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5204}
		\end{adjustbox}
		\caption{Run 5204}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5219}
		\end{adjustbox}
		\caption{Run 5219}
	\end{subfigure}
	\\
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5225}
		\end{adjustbox}
		\caption{Run 5225}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5308}
		\end{adjustbox}
		\caption{Run 5308}
	\end{subfigure}
	\\
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5311}
		\end{adjustbox}
		\caption{Run 5311}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5315}
		\end{adjustbox}
		\caption{Run 5315}
	\end{subfigure} 
	\caption[\dqdx peak position as a function of drift time for various ProtoDUNE-SP data runs]{\dqdx peak position as a function of drift time for various ProtoDUNE-SP data runs.}
	\label{fig:dqdxPeak1}
\end{figure}

\begin{figure}[t]
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5325}
		\end{adjustbox}
		\caption{Run 5325}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5387}
		\end{adjustbox}
		\caption{Run 5387}
	\end{subfigure}	
	\\
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5423}
		\end{adjustbox}
		\caption{Run 5423}
		\label{fig:dqdxPeak2:3}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/peakDrift5426}
		\end{adjustbox}
		\caption{Run 5426}
		\label{fig:dqdxPeak2:4}
	\end{subfigure}
	\caption[\dqdx peak position as a function of drift time for various ProtoDUNE-SP data runs (continued)]{\dqdx peak position as a function of drift time for various ProtoDUNE-SP data runs (continued).}
	\label{fig:dqdxPeak2}
\end{figure}

\citefig{fig:dqdxPeak2:3} and \citefig{fig:dqdxPeak2:4} shows the reason for excluding values of \tdrift above \SI{1.5}{\ms}.
Both the runs shown in these figures appear to have very long electron lifetimes and thus see very little change in the value of \dqdxMPV over the drift distance.
Therefore, space charge effects which have not been fully corrected for dominate the shape of the distribution at longer lifetimes.
This is thought to be the cause of the measured values of \dqdxMPV to increasing with drift time at larger values of \tdrift.

Each of these runs also has associated lifetimes measured by each of the purity monitors.
\citefig{fig:lifetimeComp} shows a comparison of the lifetime measured with the method above with the lifetime measured by one of the purity monitors (the one situated uppermost in the detector).
The black dotted line represents equality between the two measurements.
One can see that at lower lifetimes the methods agree relatively well but that at higher lifetimes the two methods diverge significantly.
The lifetimes measured by the other two purity monitors are not displayed because they both have larger associated errors and the central values fall within the errors provided by the upper purity monitor.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.6\linewidth, center}
		\input{files/figures/protodune_calibration/lifetimeComp}
	\end{adjustbox}
	\caption[Comparison of electron lifetime measurements made with purity monitors and cosmic ray tracks]{Comparison of electron lifetime measurements made with the upper ProtoDUNE-SP purity monitor ($\tau_{\text{PrMon}}$) and those made with cathode-anode crossing cosmic ray tracks ($\tau_{\text{Tracks}}$). The dotted line shows $\tau_{\text{PrMon}} = \tau_{\text{Tracks}}$.}
	\label{fig:lifetimeComp}
\end{figure}

One of the primary reasons to measure the electron lifetime accurately is so that accurate calorimetry may be used to measure the energy of certain particles.
Particles such as muons, which usually do not scatter, typically have their energy measured from their range in the detector.
However, charged particles which shower, such as photons and electrons and those particles which are more likely to scatter in the detector such as charged hadrons may have their energy measured by summing the collected ionisation charge they produce and translating this into an energy.

Additionally, measurements of particle \dedx are frequently used to discriminate between different particle types, for example protons and pions.

Both of these measurements include a correction for the electron lifetime depending on the position of the hit in the detector.
It is therefore important to quantify what these discrepancies in the measured value of $\tau$ translate to in terms of measured charge throughout the detector.

\citefig{fig:chargeEquivalent} shows an attempt to quantify the difference in measured charge as a function of drift time in the detector. 
This is produced for each run by plotting the function
\begin{equation}
	\exp(-\tdrift / \tau_{\text{Tracks}}) - \exp(-\tdrift / \tau_{\text{PrMon}})
\end{equation}
as a function of drift distance.
This function is equivalent to the fractional difference in charge that would be estimated under the two different lifetimes.

One can see that the measured discrepancy falls as the drift time reduces, meaning this mismeasurement will have a greater effect for those particles near the cathode. 
Although the shape of the pictured lines is produced by the sum of two exponentials, it is well approximated by a straight line passing through the origin.
Additionally, the size of the maximum charge mismeasurement is seen to vary between $\sim 1\%$ and $\sim 8\%$.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.6\linewidth, center}
		\input{files/figures/protodune_calibration/chargeEquivalent}
	\end{adjustbox}
	\caption[Fractional difference in measured charge due to lifetime discrepancy as a function of drift time]{Fractional difference in measured charge due to lifetime discrepancy as a function of drift time for various ProtoDUNE-SP data runs}
	\label{fig:chargeEquivalent}
\end{figure}

\section{Impact on oscillation measurements}
\label{sec:pdune_calibration:osc}

It is demonstrated above that, in the ProtoDUNE-SP detector, discrepancies are observed between electron lifetimes from two different sources. 
Given the similarities of the ProtoDUNE-SP detector and proposed design of the DUNE single-phase FD modules, it is reasonable to assume that such discrepancies could also occur in a long baseline oscillation analysis.  
Given that there is potentially no way to ascertain which of the lifetime values is correct, it is possible that a charge (and therefore energy) bias could be introduced for certain particle types reconstructed using calorimetry.

To assess the effect a bias in the electron lifetime could have on an oscillation analysis, the CAFAna framework is used together with simulated FD events.
The particular form of the bias is derived from \citefig{fig:chargeEquivalent} and shifts the reconstructed energy of a particle of a species $\alpha$, $E_{\alpha,~\text{reco}}$, such that
\begin{equation}
	E_{\alpha,~\text{reco}}' = E_{\alpha,~\text{reco}} \left( 1 + b_{\text{max}} \left( \frac{ x_{\text{drift, max}} - \abs{V_{x}} }{ x_{\text{drift, max}} } \right) \right) \, ,
\end{equation}
where $E_{\alpha,~\text{reco}}$ and $E_{\alpha,~\text{reco}}'$ are the original and shifted particle energies respectively, $V_{x}$ is the true vertex position of the neutrino interaction and $x_{\text{drift, max}}$ is the maximum drift distance (\SI{360}{\cm}).
$b_{\text{max}}$ is the maximum fractional change in particle energy and is derived from \citefig{fig:chargeEquivalent}, which shows that the typical energy scale mismeasurement is $\sim 5 \%$.
Therefore $b_{\text{max}}$ is set to \num{0.05}.

The particle types, $\alpha$, affected by this shift are charged and neutral hadrons, electrons and photons.
These are all expected to be reconstructed using calorimetry in the DUNE FD.

\subsection{Evaluation of effects on high statistics samples}
\label{sec:pdune_calibration:osc:highStats}

The four DUNE far detector samples are shown with and without this bias in \citefig{fig:fdSamplesLifetime}.
In these plots the chosen oscillation points are the best fit points from~\cite{nufit4} while the neutrino mass hierarchy is assumed to be normal.
These samples contain the full MC statistics and do not have statistical fluctuations added.

\begin{figure}[h]
	\begin{subfigure}[t]{.5\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/asimovNumuFhc}
		\end{adjustbox}
		\caption{FHC: reco \numu}
	\end{subfigure}	
	\hfill
	\begin{subfigure}[t]{.5\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/asimovNueFhc}
		\end{adjustbox}
		\caption{FHC: reco \nue}
	\end{subfigure}
	\\
	\begin{subfigure}[t]{.5\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/asimovNumuRhc}
		\end{adjustbox}
		\caption{RHC: reco \anumu}
	\end{subfigure}	
	\hfill
	\begin{subfigure}[t]{.5\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/asimovNueRhc}
		\end{adjustbox}
		\caption{RHC: reco \anue}
	\end{subfigure}	
	\caption[DUNE far detector samples with and without electron lifetime bias]{DUNE far detector samples with and without the electron lifetime bias. Also shown is the post fit result from an Asimov fit using the biased data with an unbiased prediction.}
	\label{fig:fdSamplesLifetime}
\end{figure}

Additionally, a FD-only fit is performed using the biased sample as the data and the nominal sample as the expected distribution. 
All cross-section, flux and detector systematics are set at their nominal values and determined in the fit 
Furthermore, the oscillation variables \thetai{23}, \thetai{13}, \dcp, \deltami{32} and $\rho$ are determined in the fit.
The resulting post fit distribution is shown as the red dashed line in \citefig{fig:fdSamplesLifetime}.

\citefig{fig:fdSamplesLifetimeRatio} shows the ratio of both the sample with the lifetime bias and the post fit distribution to the unbiased prediction.
One can see that the lifetime bias has a greater effect on the appearance samples, changing the value of some bins by up to 20\%.
For the disappearance samples the greatest changes in bin content are approximately 5\%. 
This difference is explained by the fact that the lifetime bias does not affect the reconstructed energy of muons.

\begin{figure}[h]
	\begin{subfigure}[t]{.5\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/asimovNumuFhc_ratio}
		\end{adjustbox}
		\caption{FHC: reco \numu}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/asimovNueFhc_ratio}
		\end{adjustbox}
		\caption{FHC: reco \nue}
	\end{subfigure}
	\\
	\begin{subfigure}[t]{.5\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/asimovNumuFhc_ratio}
		\end{adjustbox}
		\caption{FHC: reco \anumu}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.5\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/asimovNueFhc_ratio}
		\end{adjustbox}
		\caption{FHC: reco \anue}
	\end{subfigure}
	\caption[Ratios of DUNE FD energy biased and post fit samples to nominal]{Ratios of DUNE FD samples with lifetime bias to the unbiased sample. Also shown is the ratio of the post fit distributions to the unbiased samples.}	
	\label{fig:fdSamplesLifetimeRatio}
\end{figure}

\citefig{fig:fdSamplesLifetimeRatio} also shows that the post fit distribution is able to match the data (the samples with the lifetime bias applied) well. 
This indicates that some combination of both the systematics and oscillation variables is able to account for the introduced bias.

%%% Stuff goes here for the 2D contour things %%%
\citefig{fig:2dContoursHighStats} shows the effect this bias has on the measurement of oscillation parameters in two 2-dimensional space. 
Here, the chosen 2-dimensional spaces are \ssthetai{23} and \deltami{32} (\citefigL{fig:2dContoursHighStats}) and \ssthetai{23} and \dcp (\citefigR{fig:2dContoursHighStats}).
In both cases, one can see that, when the electron lifetime bias is introduced, the contours increase in size and move from their original positions.
This increase in the size of the contours indicates a reduction in the sensitivity of the experiment.

\begin{figure}[h]
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/ssTh23VsDmsq32}
		\end{adjustbox}
	\end{minipage}
	\hfill
	\begin{minipage}[t]{.5\linewidth}
		\begin{adjustbox}{max totalsize=\linewidth, center}
			\input{files/figures/protodune_calibration/ssTh23VsDelta}
		\end{adjustbox}
	\end{minipage}
	\caption[2D contours showing the effect of an electron lifetime bias on the measurement of neutrino oscillation parameters]{Two dimensional contours showing the effect of a bias in the electron lifetime on DUNE's ability to measure selected neutrino oscillation parameters. Contours with the electron lifetime bias are shown in red while those without are shown in black. Both 68\% contours (dashed lines), 95\% contours (solid lines) and the best fit points are shown. Left: \ssthetai{23} and \deltami{32}. Right: \ssthetai{23} and \dcp. }
	\label{fig:2dContoursHighStats}
\end{figure}

Furthermore, looking at \citefigR{fig:2dContoursHighStats}, one can see that when the lifetime bias is introduced the best fit point is shifted from the true value (black) to a different point.
However, this shift is small: the value of \deltami{32} is only shifted from \SI{2.452d-3}{\eV\squared} to \SI{2.456d-3}{\eV\squared} (a difference of $\sim 0.2\%$) while the value of \ssthetai{23} is shifted from 0.5802 to 0.5808 (a change of $\sim 0.1\%$).

\subsection{Evaluations with statistical fluctuations}
\label{sec:pdune_calibration:osc:fluctuations}

In order to assess if the introduction of this bias has any effect on the measurement of the oscillation parameters, \textbf{SOME NUMBER OF} FD-only fits are performed with and without the lifetime bias applied to the data.
In this case, statistical fluctuations are introduced to the data, equivalent to those that would be expected for 1 years POT.
Additionally, the oscillation parameters \thetai{13}, \thetai{23}, \deltami{32}, \dcp and $\rho$ are all thrown within limits. 
These limits are shown in \citetab{tab:paramThrows}.

\begin{table}
	\caption[Oscillation parameters limits used]{Throw limits on oscillation parameters used in this analysis. Note that $\rho$ is thrown according to a Gaussian distribution while all the other parameters are thrown uniformly within their ranges.}
	\label{tab:paramThrows}
	\centering
	\begin{tabular}{c c}
		\hline
		Parameter & Range \\
		\hline
		\hline
		\thetai{13} & $\ang{8.22} - \ang{8.99}$ \\
		\thetai{23} & $\ang{40.3} - \ang{52.4}$ \\
		\deltami{32} & \SIrange{2.427d-3}{2.625d-3}{\eV\squared} \\
		\dcp & $0 - 2\pi$ \\
		$\rho$ & \SI{2.85(6)}{\gram\per\cm\cubed}  \\
		\hline
	\end{tabular}
\end{table}

All flux, cross-section and detector systematics are set to their nominal values and determined in the fits.
A Gaussian penalty term is included which provides a constraint on the values of \thetai{13} and $\rho$.
For \thetai{13} this constraint is \SI{8.6(1)}{\degree} while for $\rho$ it is \SI{2.85(6)}{\gram\per\cm\cubed}.

For each of the fits, the difference between the true oscillation parameters and the best fit points is plotted in a histogram. 
The results for the biased and unbiased data are compared in \citefig{fig:paramComp5pc}.

\begin{figure}[h]
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/fluctuationsDiffTh13}
		\end{adjustbox}
		\caption{\thetai{13}}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/fluctuationsDiffRho}
		\end{adjustbox}
		\caption{Earth matter density, $\rho$}
	\end{subfigure}
	\\
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/fluctuationsDiffSinsqTh23}
		\end{adjustbox}
		\caption{$\sin^{2} \thetai{23}$}
	\end{subfigure}
	\hfill
	\begin{subfigure}[t]{.49\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/fluctuationsDiffDelta}
		\end{adjustbox}
		\caption{\dcp}
	\end{subfigure}	
	\\
	\centering
	\begin{subfigure}[t]{.5\textwidth}
		\begin{adjustbox}{max totalsize=\textwidth, center}
			\input{files/figures/protodune_calibration/fluctuationsDiffDmsq32}
		\end{adjustbox}
		\caption{\deltami{32}}
		\label{fig:paramComp5pc:dmsq32}
	\end{subfigure}
	\caption[Difference between true and best fit oscillation parameters, with and without a lifetime bias.]{Difference between true and best fit oscillation parameters, with and without a lifetime bias. The distributions for \deltami{32} are each fitted with a Gaussian.}
	\label{fig:paramComp5pc}
\end{figure}

For most of the chosen oscillation parameters we find that there is no observable difference in the parameter resolution or bias between the unbiased sample and the sample with the lifetime bias introduced.
However, \citefig{fig:paramComp5pc:dmsq32} shows that the addition of the lifetime bias causes a bias to appear in the measured value of \deltami{32}. 
However, this bias is very small, increasing from $(-1.6 \pm 3.2) \times 10^{-7}~\si{\eV\squared}$ for the sample without a lifetime bias, to \SI{4.1(3)d-6}{\eV\squared} for the sample with the lifetime bias, a shift of roughly 0.2\%.

\subsection{Increasing the value of $b_{\text{max}}$}

%% Larger bias stuff goes here
The same test is repeated with a larger lifetime bias than that observed in ProtoDUNE-SP data. 
In this case, $b_{\text{max}} = 0.15$.

The resulting distributions of $\delta_{CP,~\text{fit}} - \delta_{CP,~\text{true}}$ are shown in \citefig{fig:paramComp15Pc:delta} along with fitted Gaussian distributions.
The fit range of the Gaussian distributions is set to be between \num{-0.3} and \num{0.3}, due to the large tails of the distribution.
Although the distributions for both the unbiased dataset and the dataset with $b_{\text{max}} = 0.15$ contain the same number of entries, it can be observed that the peak is lower for the biased dataset, with more fits lying outside of the central core.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.6\textwidth, center}
		\input{files/figures/protodune_calibration/fluctuationsDiffDelta15Pc}
	\end{adjustbox}
	\caption[Difference between true and best fit value of \dcp, with and without an inflated lifetime bias.]{Difference between true and best fit value of \dcp, with and without an inflated lifetime bias. In each case, a Gaussian distribution (solid line) is fitted.}
	\label{fig:paramComp15pc:delta}
\end{figure}

Taking the value of $\sigma$ from each of the fitted Gaussian distributions shows the \dcp resolution increasing from $(0.140 \pm 0.002)\pi$ to $(0.159 \pm 0.003)\pi$, an increase of 14\%.
Furthermore, the fraction of events where the bias in \dcp is greater than $0.3\pi$ is increase from.

\citefig{fig:paramComp15pc:dmsq32} shows the distributions for \deltami{32} for both the biased and unbiased dataset.

\begin{figure}[h]
	\begin{adjustbox}{max totalsize=.6\textwidth, center}
		\input{files/figures/protodune_calibration/fluctuationsDiffDmsq3215Pc}
	\end{adjustbox}
	\caption[Difference between true and best fit value of \deltami{32}, with and without an inflated lifetime bias.]{Difference between true and best fit value of \deltami{32}, with and without an inflated lifetime bias. In each case, a Gaussian distribution (solid line) is fitted.}
	\label{fig:paramComp15pc:dmsq32}
\end{figure}

